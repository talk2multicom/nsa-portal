<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSA Ecosystem Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .gradient-button {
            background: linear-gradient(135deg, #0d9488, #14b8a6);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        input, select, textarea {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
            outline: none;
        }
        .tab-button {
            flex: 1;
            padding: 12px;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .tab-button.active {
            background-color: #0d9488;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(13, 148, 136, 0.2), 0 2px 4px -1px rgba(13, 148, 136, 0.12);
        }
        .tab-button:not(.active) {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .tab-button:hover:not(.active) {
            background-color: #cbd5e0;
        }
        .dashboard-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            transition: transform 0.2s ease-in-out;
        }
        .stat-box {
            background-color: #f0fdfa;
            border: 1px solid #99f6e4;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }
        .list-item:hover { background-color: #f1f5f9; }
        .list-item:last-child { border-bottom: none; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .banner-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <!-- Main Container to hold all pages -->
    <div id="app-container" class="w-full max-w-5xl mx-auto flex flex-col items-center">

        <!-- Login Portal Page -->
        <div id="login-page" class="w-full max-w-sm">
            <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-sm">
                <h1 class="text-2xl font-bold text-center text-gray-800">NSA Ecosystem</h1>
                <p class="text-center text-sm text-gray-500 mt-2">Sign in to access your portal.</p>
                <form id="login-form" class="mt-8 space-y-6">
                    <div>
                        <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                        <input type="email" id="email" name="email" placeholder="you@nsa.com" class="w-full" required>
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                        <input type="password" id="password" name="password" placeholder="••••••••" class="w-full" required>
                    </div>
                    <button type="submit" id="login-button" class="gradient-button w-full">Sign In</button>
                </form>
                <div class="mt-4 text-center">
                    <button id="google-login-button" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full w-full flex items-center justify-center space-x-2 transition-colors duration-200 hover:bg-gray-100">
                        <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44.5 20h-2.5v-2h-3v2h-2.5a18.9 18.9 0 00-17.5-12.7c-10.4 0-18.9 8.5-18.9 18.9s8.5 18.9 18.9 18.9c5.2 0 9.9-2.1 13.3-5.5l-3-2.3c-2.8 2.2-6.5 3.5-10.3 3.5-7.7 0-14-6.3-14-14s6.3-14 14-14c4.6 0 8.8 2.2 11.5 5.8l-5.5 5.8h13.5v-11z" fill="#4285F4"/>
                            <path d="M44.5 20h-2.5v-2h-3v2h-2.5a18.9 18.9 0 00-17.5-12.7c-10.4 0-18.9 8.5-18.9 18.9s8.5 18.9 18.9 18.9c5.2 0 9.9-2.1 13.3-5.5l-3-2.3c-2.8 2.2-6.5 3.5-10.3 3.5-7.7 0-14-6.3-14-14s6.3-14 14-14c4.6 0 8.8 2.2 11.5 5.8l-5.5 5.8h13.5v-11z" fill="white" opacity="0"/>
                            <path d="M24 37.9c-7.7 0-14-6.3-14-14s6.3-14 14-14c4.6 0 8.8 2.2 11.5 5.8l-5.5 5.8h13.5v-11z" fill="#34A853"/>
                            <path d="M37.9 24c0 1.2-.1 2.3-.3 3.4h-13.6v-6.8h7.9c-.3-1.6-1.1-3.2-2.3-4.4l-5.5-5.8c3.2-3.4 7.9-5.5 13.3-5.5 10.4 0 18.9 8.5 18.9 18.9s-8.5 18.9-18.9 18.9c-5.2 0-9.9-2.1-13.3-5.5l3-2.3c3.8 2.2 7.7 3.5 11.5 3.5 7.7 0 14-6.3 14-14z" fill="#FBBC05"/>
                            <path d="M24 10.1c4.6 0 8.8 2.2 11.5 5.8l-5.5 5.8h13.5v-11z" fill="#EA4335"/>
                        </svg>
                        <span>Sign in with Google</span>
                    </button>
                </div>
                <div class="mt-6 text-center text-sm text-gray-500">
                    <p>Are you a customer or validator?</p>
                    <button id="show-public-portal" class="text-teal-600 font-medium hover:underline">
                        Access Public Portal
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Page (initially hidden) -->
        <div id="admin-page" class="hidden w-full max-w-5xl">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-5xl mb-4">
                <h1 class="text-3xl font-bold text-center text-gray-800">NSA Admin Dashboard</h1>
                <p class="text-center text-sm text-gray-500 mt-2">Real-time analytics and management.</p>
                <div class="mt-4 text-xs text-center text-gray-400">User ID: <span id="admin-user-id">Loading...</span></div>
                <div class="mt-2 text-center">
                    <button id="admin-sign-out" class="text-sm text-teal-600 hover:underline">Sign Out</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-5xl">
                <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8">
                    <button id="admin-overview-tab" class="tab-button active">Overview</button>
                    <button id="admin-inventory-tab" class="tab-button">Inventory</button>
                    <button id="admin-sales-tab" class="tab-button">Sales</button>
                    <button id="admin-incidents-tab" class="tab-button">Incidents</button>
                    <button id="admin-traceability-tab" class="tab-button">Traceability</button>
                    <button id="admin-training-tab" class="tab-button">Training</button>
                    <button id="admin-regulator-tab" class="tab-button">Regulator</button>
                    <button id="admin-warehouse-tab" class="tab-button">Warehouse</button>
                    <button id="admin-assets-tab" class="tab-button">Assets</button>
                    <button id="admin-reports-tab" class="tab-button">Reports</button>
                    <button id="admin-tasks-tab" class="tab-button">Tasks</button>
                    <button id="admin-orders-tab" class="tab-button">Orders</button>
                    <button id="admin-ble-tracking-tab" class="tab-button">BLE Tracking</button>
                </div>
                <div id="admin-overview-panel" class="tab-content space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="stat-box">
                            <p class="text-sm font-medium text-gray-500">Total Sales Revenue</p>
                            <p id="total-revenue" class="mt-1 text-3xl font-bold text-emerald-600">GHS 0.00</p>
                        </div>
                        <div class="stat-box">
                            <p class="text-sm font-medium text-gray-500">Incidents Reported</p>
                            <p id="total-incidents" class="mt-1 text-3xl font-bold text-red-500">0</p>
                        </div>
                        <div class="stat-box">
                            <p class="text-sm font-medium text-gray-500">Inventory Logs</p>
                            <p id="total-inventory" class="mt-1 text-3xl font-bold text-sky-500">0</p>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">AI Vet Analytics (Simulated)</h2>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-4 p-4 rounded-lg bg-red-50">
                                <div class="text-red-500">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                     </svg>
                                </div>
                                <div>
                                    <p class="text-gray-900 font-medium">Mortality Trend Analysis</p>
                                    <p id="mortality-trend" class="text-gray-600 text-sm">Loading...</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4 p-4 rounded-lg bg-teal-50">
                                <div class="text-teal-500">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m-4-10l-8 4m8-4v10" />
                                     </svg>
                                </div>
                                <div>
                                    <p class="text-gray-900 font-medium">Feed Usage Forecast</p>
                                    <p id="feed-forecast" class="text-gray-600 text-sm">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="admin-inventory-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Recent Inventory Logs</h2>
                    <div id="admin-inventory-list" class="space-y-2">
                        <p class="text-center text-gray-500">Loading inventory data...</p>
                    </div>
                </div>
                <div id="admin-sales-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Recent Sales Logs</h2>
                    <div id="admin-sales-list" class="space-y-2">
                        <p class="text-center text-gray-500">Loading sales data...</p>
                    </div>
                </div>
                <div id="admin-incidents-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Recent Incidents</h2>
                    <div id="admin-incidents-list" class="space-y-2">
                        <p class="text-center text-gray-500">Loading incident data...</p>
                    </div>
                </div>
                <!-- Admin Traceability Panel -->
                <div id="admin-traceability-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Generate Traceable Batch</h2>
                    <form id="batch-generator-form" class="space-y-6">
                        <div>
                            <label for="coopId" class="block text-gray-700 font-medium mb-2">Coop ID</label>
                            <input type="text" id="coopId" name="coopId" placeholder="e.g., Coop-A" class="w-full" required>
                        </div>
                        <div>
                            <label for="birdCount" class="block text-gray-700 font-medium mb-2">Bird Count</label>
                            <input type="number" id="birdCount" name="birdCount" placeholder="e.g., 500" class="w-full" required>
                        </div>
                        <div>
                            <label for="feedType" class="block text-gray-700 font-medium mb-2">Feed Type</label>
                            <input type="text" id="feedType" name="feedType" placeholder="e.g., Finisher Mash" class="w-full" required>
                        </div>
                        <div>
                            <label for="batchNotes" class="block text-gray-700 font-medium mb-2">Batch Notes</label>
                            <textarea id="batchNotes" name="batchNotes" rows="3" placeholder="Notes on batch..." class="w-full"></textarea>
                        </div>
                        <button type="submit" id="generate-batch-button" class="gradient-button w-full">Generate Traceable Batch</button>
                    </form>
                    <div id="generated-qr-code" class="mt-8 hidden p-6 bg-gray-50 rounded-lg shadow-inner text-center">
                        <h3 class="font-bold text-gray-700">Generated Batch ID (for QR Code)</h3>
                        <p id="generated-batch-id" class="text-xl font-mono text-teal-600 my-2 break-all"></p>
                        <p class="text-sm text-gray-500">Copy this ID to generate a physical QR code for the batch.</p>
                        <button id="copy-qr-code" class="mt-4 text-sm text-teal-600 hover:underline">Copy to Clipboard</button>
                    </div>
                </div>

                <!-- Admin Training Panel (New) -->
                <div id="admin-training-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Manage Training & Students</h2>
                    <form id="training-form" class="space-y-4">
                        <div>
                            <label for="material-title" class="block text-gray-700 font-medium mb-2">Training Material Title</label>
                            <input type="text" id="material-title" placeholder="e.g., Biosecurity Protocols" class="w-full" required>
                        </div>
                        <div>
                            <label for="material-link" class="block text-gray-700 font-medium mb-2">Video/PDF Link</label>
                            <input type="text" id="material-link" placeholder="https://..." class="w-full" required>
                        </div>
                        <button type="submit" class="gradient-button w-full">Upload Material</button>
                    </form>
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-700">Student Progress Tracker (Mock)</h3>
                        <div id="student-list" class="mt-4 space-y-2">
                             <p class="text-gray-500 text-center">No students enrolled yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Regulator Panel (New) -->
                <div id="admin-regulator-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Regulator & Audit Access (Read-Only)</h2>
                    <p class="text-sm text-gray-500 text-center">This panel provides a read-only view of all farm data for auditing purposes. All changes are logged and watermarked.</p>
                    <div class="mt-8 space-y-4">
                        <h3 class="font-semibold text-gray-700">All Incident Logs (Across Farms)</h3>
                        <div id="regulator-incidents" class="space-y-2">
                            <p class="text-gray-500 text-center">Loading regulator data...</p>
                        </div>
                        <h3 class="font-semibold text-gray-700 mt-6">All Traceability Logs</h3>
                        <div id="regulator-traceability" class="space-y-2">
                            <p class="text-gray-500 text-center">Loading regulator data...</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Warehouse Panel (New) -->
                <div id="admin-warehouse-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Warehouse Management</h2>
                    
                    <div class="dashboard-card mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Log Incoming Delivery</h3>
                        <form id="warehouse-delivery-form" class="space-y-4">
                            <div>
                                <label for="warehouse-item-name" class="block text-gray-700 font-medium mb-2">Item Name</label>
                                <input type="text" id="warehouse-item-name" name="itemName" placeholder="e.g., Finisher Mash" class="w-full" required>
                            </div>
                            <div>
                                <label for="warehouse-item-type" class="block text-gray-700 font-medium mb-2">Item Type</label>
                                <select id="warehouse-item-type" name="itemType" class="w-full">
                                    <option value="feed">Feed</option>
                                    <option value="medicine">Medicine</option>
                                    <option value="vaccine">Vaccine</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="warehouse-quantity" class="block text-gray-700 font-medium mb-2">Quantity</label>
                                <input type="number" id="warehouse-quantity" name="quantity" placeholder="e.g., 100" class="w-full" required>
                            </div>
                            <div>
                                <label for="warehouse-supplier" class="block text-gray-700 font-medium mb-2">Supplier</label>
                                <input type="text" id="warehouse-supplier" name="supplier" placeholder="e.g., Agricorp Ltd." class="w-full">
                            </div>
                            <button type="submit" class="gradient-button w-full">Log Delivery</button>
                        </form>
                    </div>

                    <div class="dashboard-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Dispatch Inventory to Staff</h3>
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">Current Stock Levels</h4>
                            <div id="warehouse-stock-list" class="space-y-2">
                                <p class="text-gray-500">Loading stock data...</p>
                            </div>
                        </div>
                        <form id="dispatch-form" class="space-y-4 mt-8">
                            <div>
                                <label for="dispatch-item-name" class="block text-gray-700 font-medium mb-2">Item to Dispatch</label>
                                <select id="dispatch-item-name" name="itemName" class="w-full" required>
                                    <option value="">-- Select an item --</option>
                                </select>
                            </div>
                            <div>
                                <label for="dispatch-quantity" class="block text-gray-700 font-medium mb-2">Quantity to Dispatch</label>
                                <input type="number" id="dispatch-quantity" name="quantity" placeholder="e.g., 10" class="w-full" required>
                            </div>
                            <div>
                                <label for="dispatch-staff-uid" class="block text-gray-700 font-medium mb-2">Recipient Staff User ID</label>
                                <input type="text" id="dispatch-staff-uid" name="staffUid" placeholder="Enter Staff User ID" class="w-full" required>
                            </div>
                            <button type="submit" class="gradient-button w-full">Dispatch Item</button>
                        </form>
                    </div>
                </div>
                
                <!-- Admin Asset Tracking Panel (New) -->
                <div id="admin-assets-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Asset Management</h2>
                    <div class="dashboard-card mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Add New Asset</h3>
                        <form id="add-asset-form" class="space-y-4">
                            <div>
                                <label for="asset-name" class="block text-gray-700 font-medium mb-2">Asset Name</label>
                                <input type="text" id="asset-name" name="name" placeholder="e.g., Delivery Truck #1" class="w-full" required>
                            </div>
                            <div>
                                <label for="asset-type" class="block text-gray-700 font-medium mb-2">Asset Type</label>
                                <input type="text" id="asset-type" name="type" placeholder="e.g., Vehicle, Equipment" class="w-full" required>
                            </div>
                            <div>
                                <label for="asset-assigned-to" class="block text-gray-700 font-medium mb-2">Assigned To (Staff User ID)</label>
                                <input type="text" id="asset-assigned-to" name="assignedTo" placeholder="Enter Staff User ID" class="w-full">
                            </div>
                            <button type="submit" class="gradient-button w-full">Add Asset</button>
                        </form>
                    </div>

                    <div class="dashboard-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Current Asset Status</h3>
                        <div id="admin-asset-list" class="space-y-2">
                            <p class="text-gray-500">Loading asset data...</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Reports Panel (New) -->
                <div id="admin-reports-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Reports & Analytics</h2>
                    <div class="dashboard-card mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Key Metrics Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="stat-box">
                                <p class="text-sm font-medium text-gray-500">Total Sales Revenue</p>
                                <p id="report-total-revenue" class="mt-1 text-3xl font-bold text-emerald-600">GHS 0.00</p>
                            </div>
                            <div class="stat-box">
                                <p class="text-sm font-medium text-gray-500">Incidents Reported</p>
                                <p id="report-total-incidents" class="mt-1 text-3xl font-bold text-red-500">0</p>
                            </div>
                            <div class="stat-box">
                                <p class="text-sm font-medium text-gray-500">Total Deliveries</p>
                                <p id="report-total-deliveries" class="mt-1 text-3xl font-bold text-sky-500">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Download Reports</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="download-pdf-report" class="gradient-button flex items-center justify-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2h-8a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 100-2H6zm0 4a1 1 0 000 2h8a1 1 0 100-2H6zm0 4a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                                <span>Download PDF Report</span>
                            </button>
                            <button id="download-excel-report" class="gradient-button flex items-center justify-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-11.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L8.586 11H3a1 1 0 110-2h5.586L6.293 7.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                <span>Download Excel Report</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Tasks Panel (New) -->
                <div id="admin-tasks-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Task Assignment</h2>
                    <div class="dashboard-card mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Assign a New Task</h3>
                        <form id="assign-task-form" class="space-y-4">
                            <div>
                                <label for="task-title" class="block text-gray-700 font-medium mb-2">Task Title</label>
                                <input type="text" id="task-title" name="title" placeholder="e.g., Feed Delivery to Coop B" class="w-full" required>
                            </div>
                            <div>
                                <label for="task-description" class="block text-gray-700 font-medium mb-2">Description</label>
                                <textarea id="task-description" name="description" rows="3" placeholder="Provide details of the task..." class="w-full" required></textarea>
                            </div>
                            <div>
                                <label for="task-assigned-to" class="block text-gray-700 font-medium mb-2">Assigned To (Staff User ID)</label>
                                <input type="text" id="task-assigned-to" name="assignedTo" placeholder="Enter Staff User ID" class="w-full" required>
                            </div>
                            <div>
                                <label for="task-due-date" class="block text-gray-700 font-medium mb-2">Due Date</label>
                                <input type="date" id="task-due-date" name="dueDate" class="w-full">
                            </div>
                            <button type="submit" class="gradient-button w-full">Assign Task</button>
                        </form>
                    </div>

                    <div class="dashboard-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Current Tasks</h3>
                        <div id="admin-task-list" class="space-y-2">
                            <p class="text-gray-500">Loading task data...</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Orders Panel (New) -->
                <div id="admin-orders-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Customer Orders</h2>
                    <div id="admin-orders-list" class="space-y-4">
                        <p class="text-gray-500 text-center">No orders found.</p>
                    </div>
                </div>

                <!-- Admin BLE Tracking Panel (New) -->
                <div id="admin-ble-tracking-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Live BLE Staff Tracking (Simulated)</h2>
                    <div class="dashboard-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Live Location Feed</h3>
                        <div id="ble-tracking-list" class="space-y-4">
                             <p class="text-gray-500">Awaiting BLE logs...</p>
                        </div>
                        <button id="simulate-ble-data" class="gradient-button mt-4 w-full text-sm">Simulate New BLE Log</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Field Staff App Page (initially hidden) -->
        <div id="staff-page" class="hidden w-full max-w-2xl">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl mb-4">
                <h1 class="text-2xl font-bold text-center text-gray-800">Field Staff App</h1>
                <p class="text-center text-sm text-gray-500 mt-2">Log and track data in real-time.</p>
                <div class="mt-4 text-xs text-center text-gray-400">User ID: <span id="staff-user-id">Loading...</span></div>
                <div class="mt-2 text-center">
                    <button id="staff-sign-out" class="text-sm text-teal-600 hover:underline">Sign Out</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
                <div class="flex justify-center space-x-2 mb-8">
                    <button id="staff-inventory-tab" class="tab-button active">Inventory</button>
                    <button id="staff-sales-tab" class="tab-button">Sales</button>
                    <button id="staff-incidents-tab" class="tab-button">Incidents</button>
                    <button id="staff-assets-tab" class="tab-button">Assets</button>
                    <button id="staff-tasks-tab" class="tab-button">Tasks</button>
                </div>
                <div id="staff-inventory-panel" class="tab-content space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700 text-center">Log Inventory Delivery</h2>
                    <form id="inventory-form" class="space-y-6">
                        <div>
                            <label for="coop-id" class="block text-gray-700 font-medium mb-2">Coop ID</label>
                            <input type="text" id="coop-id" name="coop-id" placeholder="e.g., Coop-A" class="w-full" required>
                        </div>
                        <div>
                            <label for="itemType" class="block text-gray-700 font-medium mb-2">Item Type</label>
                            <select id="itemType" name="itemType" class="w-full">
                                <option value="feed">Feed</option>
                                <option value="medicine">Medicine</option>
                                <option value="vaccine">Vaccine</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="itemName" class="block text-gray-700 font-medium mb-2">Item Name</label>
                            <input type="text" id="itemName" name="itemName" placeholder="e.g., Layer Mash" class="w-full" required>
                        </div>
                        <div>
                            <label for="quantity" class="block text-gray-700 font-medium mb-2">Quantity</label>
                            <input type="number" id="quantity" name="quantity" placeholder="e.g., 50 (bags/bottles)" class="w-full" required>
                        </div>
                        <div>
                            <label for="deliveryNotes" class="block text-gray-700 font-medium mb-2">Delivery Notes</label>
                            <textarea id="deliveryNotes" name="deliveryNotes" rows="3" placeholder="Notes on delivery..." class="w-full"></textarea>
                        </div>
                        <button type="submit" id="log-inventory-button" class="gradient-button w-full">Log Inventory</button>
                    </form>

                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-700">Recent Deliveries</h3>
                        <div id="recent-inventory-list" class="mt-4 space-y-2">
                            <p class="text-gray-500 text-center">No recent deliveries logged.</p>
                        </div>
                    </div>
                </div>
                <div id="staff-sales-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Track Sales</h2>
                    <form id="sales-form" class="space-y-6">
                        <div>
                            <label for="saleItem" class="block text-gray-700 font-medium mb-2">Item Sold</label>
                            <select id="saleItem" name="saleItem" class="w-full">
                                <option value="birds">Birds</option>
                                <option value="eggs">Eggs</option>
                            </select>
                        </div>
                        <div>
                            <label for="saleQuantity" class="block text-gray-700 font-medium mb-2">Quantity Sold</label>
                            <input type="number" id="saleQuantity" name="saleQuantity" placeholder="e.g., 10 (birds) or 100 (eggs)" class="w-full">
                        </div>
                        <div>
                            <label for="salePrice" class="block text-gray-700 font-medium mb-2">Total Revenue (GHS)</label>
                            <input type="number" id="salePrice" name="salePrice" placeholder="e.g., 500" step="0.01" class="w-full">
                        </div>
                        <div>
                            <label for="saleNotes" class="block text-gray-700 font-medium mb-2">Sale Notes</label>
                            <textarea id="saleNotes" name="saleNotes" rows="3" placeholder="Buyer details, payment method, etc." class="w-full"></textarea>
                        </div>
                        <button type="submit" id="log-sales-button" class="gradient-button w-full">Log Sales</button>
                    </form>
                </div>
                <div id="staff-incidents-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Report Incident</h2>
                    <form id="incidents-form" class="space-y-6">
                        <div>
                            <label for="incidentType" class="block text-gray-700 font-medium mb-2">Incident Type</label>
                            <select id="incidentType" name="incidentType" class="w-full">
                                <option value="mortality">Mortality</option>
                                <option value="disease">Disease Outbreak</option>
                                <option value="supply">Supply Shortage</option>
                            </select>
                        </div>
                        <div>
                            <label for="incidentTitle" class="block text-gray-700 font-medium mb-2">Incident Title</label>
                            <input type="text" id="incidentTitle" name="incidentTitle" placeholder="e.g., High Mortality in Coop B" class="w-full">
                        </div>
                        <div>
                            <label for="incidentNotes" class="block text-gray-700 font-medium mb-2">Description</label>
                            <textarea id="incidentNotes" name="incidentNotes" rows="5" placeholder="Provide details, affected coop, number of birds, etc." class="w-full"></textarea>
                        </div>
                        <div>
                            <label for="incidentPhoto" class="block text-gray-700 font-medium mb-2">Photo Upload</label>
                            <input type="file" id="incidentPhoto" name="incidentPhoto" accept="image/*" class="w-full">
                        </div>
                        <button type="submit" id="report-incident-button" class="gradient-button w-full">Report Incident</button>
                    </form>
                </div>
                <!-- Staff Asset Tracking Panel (New) -->
                <div id="staff-assets-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">My Assigned Assets</h2>
                    <div id="staff-asset-list" class="space-y-4">
                        <p class="text-gray-500 text-center">No assets assigned.</p>
                    </div>
                </div>
                 <!-- Staff Tasks Panel (New) -->
                <div id="staff-tasks-panel" class="tab-content hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">My Work Orders</h2>
                    <div id="staff-task-list" class="space-y-4">
                        <p class="text-gray-500 text-center">No tasks assigned.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Marketplace & Validator Page (initially hidden) -->
        <div id="public-page" class="hidden w-full max-w-4xl">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl mb-4">
                <h1 class="text-3xl font-bold text-center text-gray-800">NSA Customer Portal</h1>
                <p class="text-center text-sm text-gray-500 mt-2">Browse our products and track your orders.</p>
                <div class="mt-4 text-xs text-center text-gray-400">User ID: <span id="customer-user-id">Loading...</span></div>
                <div class="mt-2 text-center">
                    <button id="show-login-portal" class="text-sm text-teal-600 hover:underline">Internal Sign-in</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl">
                <div class="flex justify-center space-x-2 md:space-x-4 mb-8">
                    <button id="marketplace-tab" class="tab-button active">Marketplace</button>
                    <button id="order-tracking-tab" class="tab-button">Track Order</button>
                    <button id="traceability-tab" class="tab-button">Traceability</button>
                </div>
                <div id="marketplace-panel" class="tab-content space-y-8">
                    <div class="relative w-full h-96 rounded-xl overflow-hidden shadow-lg">
                        <img src="https://images.unsplash.com/photo-1579621970795-87facc2f976d?q=80&w=2000&auto=format&fit=crop" alt="Smart Agro" class="absolute inset-0 w-full h-full object-cover z-0 transition-transform duration-500 hover:scale-105">
                        <div class="relative z-10 flex flex-col items-center justify-center h-full text-white bg-black bg-opacity-40 p-4">
                            <h2 class="text-4xl md:text-5xl font-extrabold text-center tracking-tight">Smart Agriculture</h2>
                            <p class="mt-2 text-lg text-center font-medium">Farming for a sustainable future.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="p-6 rounded-xl bg-green-50 shadow-inner flex flex-col items-center text-center">
                            <img src="https://images.unsplash.com/photo-1617208491873-a657c6b24d73?q=80&w=2000&auto=format&fit=crop" alt="Poultry" class="w-full h-40 object-cover rounded-lg mb-4">
                            <p class="font-bold text-gray-800">Poultry</p>
                        </div>
                        <div class="p-6 rounded-xl bg-blue-50 shadow-inner flex flex-col items-center text-center">
                            <img src="https://images.unsplash.com/photo-1549646467-f273b53f33de?q=80&w=2000&auto=format&fit=fit=crop" alt="Cold Chain" class="w-full h-40 object-cover rounded-lg mb-4">
                            <p class="font-bold text-gray-800">Cold Chain</p>
                        </div>
                        <div class="p-6 rounded-xl bg-orange-50 shadow-inner flex flex-col items-center text-center">
                            <img src="https://images.unsplash.com/photo-1582234375003-88390885e347?q=80&w=2000&auto=format&fit=fit=crop" alt="Post-Harvest" class="w-full h-40 object-cover rounded-lg mb-4">
                            <p class="font-bold text-gray-800">Post-Harvest</p>
                        </div>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-700 text-center">Available Products</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-6 bg-white rounded-xl shadow-lg">
                            <img class="product-image w-full rounded-lg mb-4" src="https://placehold.co/400x300/e2e8f0/4a5568?text=Birds+for+Sale" alt="A group of chickens">
                            <h3 class="text-xl font-bold text-gray-800">Live Birds</h3>
                            <p class="text-gray-500 mt-1">Healthy, organically raised birds.</p>
                            <button id="buy-birds" class="gradient-button mt-4 w-full">Order Now</button>
                        </div>
                        <div class="card p-6 bg-white rounded-xl shadow-lg">
                            <img class="product-image w-full rounded-lg mb-4" src="https://placehold.co/400x300/e2e8f0/4a5568?text=Fresh+Eggs" alt="A carton of fresh eggs">
                            <h3 class="text-xl font-bold text-gray-800">Fresh Eggs</h3>
                            <p class="text-gray-500 mt-1">Farm-fresh, large brown eggs.</p>
                            <button id="buy-eggs" class="gradient-button mt-4 w-full">Order Now</button>
                        </div>
                    </div>
                    <div id="order-form-container" class="mt-8 hidden">
                        <h2 class="text-2xl font-semibold text-gray-700 text-center mb-6">Place Your Order</h2>
                        <form id="order-form" class="space-y-6">
                            <div>
                                <label for="customerName" class="block text-gray-700 font-medium mb-2">Your Name</label>
                                <input type="text" id="customerName" name="customerName" placeholder="John Doe" class="w-full" required>
                            </div>
                            <div>
                                <label for="customerEmail" class="block text-gray-700 font-medium mb-2">Email</label>
                                <input type="email" id="customerEmail" name="customerEmail" placeholder="you@example.com" class="w-full" required>
                            </div>
                            <div>
                                <label for="product" class="block text-gray-700 font-medium mb-2">Product</label>
                                <input type="text" id="product" name="product" class="w-full bg-gray-200 cursor-not-allowed" readonly required>
                            </div>
                            <div>
                                <label for="quantity" class="block text-gray-700 font-medium mb-2">Quantity</label>
                                <input type="number" id="quantity" name="quantity" placeholder="e.g., 100" class="w-full" required>
                            </div>
                            <div>
                                <label for="paymentMethod" class="block text-gray-700 font-medium mb-2">Payment Method</label>
                                <select id="paymentMethod" name="paymentMethod" class="w-full" required>
                                    <option value="memo">Memo</option>
                                    <option value="bank-transfer">Bank Transfer</option>
                                    <option value="card">Visa/MasterCard</option>
                                </select>
                            </div>
                            <button type="submit" id="submit-order-button" class="gradient-button w-full">Submit Order Request</button>
                        </form>
                    </div>
                </div>
                <div id="order-tracking-panel" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 text-center mb-6">Track Your Order</h2>
                    <div class="space-y-4">
                        <p class="text-center text-gray-500">Enter your order ID below.</p>
                        <div>
                            <label for="order-id-input" class="block text-gray-700 font-medium mb-2">Order ID</label>
                            <input type="text" id="order-id-input" placeholder="e.g., ORD-A1B2C3D4" class="w-full">
                        </div>
                        <button id="track-order-button" class="gradient-button w-full">Track Order</button>
                    </div>
                    <div id="tracking-result" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner hidden">
                        <h3 class="text-xl font-semibold text-center mb-4 text-emerald-600">Order Details</h3>
                        <div class="space-y-4 text-gray-700">
                            <div class="flex justify-between">
                                <span class="font-medium">Order ID:</span>
                                <span id="result-order-id"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Product:</span>
                                <span id="result-product"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Quantity:</span>
                                <span id="result-quantity"></span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="font-medium">Payment Method:</span>
                                <span id="result-payment-method" class="text-sm text-right"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Current Status:</span>
                                <span id="result-status" class="font-bold text-blue-500"></span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="font-medium">Delivery History:</span>
                                <ul id="result-delivery-history" class="list-disc list-inside text-sm text-gray-600 ml-4"></ul>
                            </div>
                        </div>
                    </div>
                    <div id="tracking-error" class="mt-8 p-6 bg-red-50 text-red-700 border border-red-200 rounded-lg hidden">
                        <p class="text-center font-medium">Order not found. Please check the ID and try again.</p>
                    </div>
                </div>
                <!-- Public Traceability Panel (new) -->
                <div id="traceability-panel" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 text-center mb-6">Validate Product Traceability</h2>
                    <div class="space-y-4">
                        <p class="text-center text-gray-500">Enter a product Batch ID to view its history.</p>
                        <div>
                            <label for="batch-id-input" class="block text-gray-700 font-medium mb-2">Batch ID</label>
                            <input type="text" id="batch-id-input" placeholder="e.g., BATCH-12345" class="w-full">
                        </div>
                        <button id="validate-batch-button" class="gradient-button w-full">Validate Batch</button>
                    </div>
                    <div id="validation-result" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner hidden">
                        <h3 class="text-xl font-semibold text-center mb-4 text-emerald-600">Batch Details</h3>
                        <div class="space-y-4 text-gray-700">
                            <div class="flex justify-between">
                                <span class="font-medium">Batch ID:</span>
                                <span id="result-batch-id"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Coop ID:</span>
                                <span id="result-coop-id"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Bird Count:</span>
                                <span id="result-bird-count"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Feed Type:</span>
                                <span id="result-feed-type"></span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="font-medium">Blockchain Hash:</span>
                                <span id="result-blockchain-hash" class="text-xs font-mono text-gray-600 break-all text-right"></span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="font-medium">Notes:</span>
                                <span id="result-batch-notes" class="text-xs text-gray-600 text-right"></span>
                            </div>
                        </div>
                    </div>
                    <div id="validation-error" class="mt-8 p-6 bg-red-50 text-red-700 border border-red-200 rounded-lg hidden">
                        <p class="text-center font-medium">Batch not found. Please check the ID and try again.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>powered by MulticomIOT</p>
    </footer>

    <!-- Modal for custom alerts -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <button id="modal-close" class="gradient-button w-full">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, addDoc, collection, doc, getDoc, onSnapshot, query, where, serverTimestamp, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        
        // Libraries for PDF and Excel generation from CDNs
        import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js";
        import "https://unpkg.com/xlsx/dist/xlsx.full.min.js";
        
        // Constants
        const appId = 'nsa-miot';
        const firebaseConfig = {
            apiKey: "AIzaSyDDbxNeMpLncUVPJtmtsFzNq0zLA9nHB_U",
            authDomain: "nsa-miot.firebaseapp.com",
            projectId: "nsa-miot",
            storageBucket: "nsa-miot.firebasestorage.app",
            messagingSenderId: "1078189349427",
            appId: "1:1078189349427:web:9c4d6503c71da21fd2a146",
            measurementId: "G-9RFX2052QE"
        };
        
        // Firebase initialization
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase initialized successfully.');
        } catch (e) {
            console.error('Firebase initialization failed:', e);
            showModal('Initialization Error', 'Failed to initialize Firebase. Check your configuration.');
        }

        // --- UI & State Management ---
        const loginPage = document.getElementById('login-page');
        const adminPage = document.getElementById('admin-page');
        const staffPage = document.getElementById('staff-page');
        const publicPage = document.getElementById('public-page');

        function showPage(pageName) {
            // Hide all pages first
            loginPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            staffPage.classList.add('hidden');
            publicPage.classList.add('hidden');
            
            // Show only the requested page
            if (pageName === 'login') {
                loginPage.classList.remove('hidden');
            } else if (pageName === 'admin') {
                adminPage.classList.remove('hidden');
            } else if (pageName === 'staff') {
                staffPage.classList.remove('hidden');
            } else if (pageName === 'public') {
                publicPage.classList.remove('hidden');
            }
        }

        // --- Authentication & Redirection ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.isAnonymous) {
                    document.getElementById('customer-user-id').textContent = user.uid;
                    showPage('public');
                } else if (user.email === 'admin@nsa.com') {
                    document.getElementById('admin-user-id').textContent = user.uid;
                    showPage('admin');
                } else if (user.email === 'staff@nsa.com') {
                    document.getElementById('staff-user-id').textContent = user.uid;
                    showPage('staff');
                } else {
                    signOut(auth);
                    showModal('Access Denied', 'Your account does not have access to an internal portal.');
                    showPage('login');
                }
            } else {
                showPage('login');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                showModal('Login Failed', 'Invalid email or password. Please try again.');
            }
        });

        document.getElementById('google-login-button').onclick = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google login failed:", error);
                showModal('Google Login Failed', 'There was an error with Google sign-in. Please try again.');
            }
        };

        document.getElementById('show-public-portal').onclick = () => {
            signInAnonymously(auth).then(() => {
                // onAuthStateChanged will handle the rest
            }).catch(error => {
                console.error('Anonymous sign-in failed:', error);
                showModal('Authentication Failed', 'Could not sign in to the public portal.');
            });
        };

        document.getElementById('admin-sign-out').onclick = () => signOut(auth);
        document.getElementById('staff-sign-out').onclick = () => signOut(auth);
        document.getElementById('show-login-portal').onclick = () => signOut(auth);

        // --- Admin Dashboard Logic ---
        const adminTabs = ['overview', 'inventory', 'sales', 'incidents', 'traceability', 'training', 'regulator', 'warehouse', 'assets', 'reports', 'tasks', 'orders', 'ble-tracking'];
        adminTabs.forEach(tab => {
            document.getElementById(`admin-${tab}-tab`).onclick = () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`admin-${tab}-tab`).classList.add('active');
                document.getElementById(`admin-${tab}-panel`).classList.remove('hidden');
            };
        });

        let salesData = [];
        let incidentsData = [];
        let deliveriesData = [];

        function updateAdminAnalytics() {
            const mortalityCount = incidentsData.filter(i => i.incidentType === 'mortality').length;
            const mortalityTrend = mortalityCount > 5 ? 'High mortality detected. Immediate action required.' : 'Mortality is within normal range.';
            const totalFeedQuantity = deliveriesData.filter(i => i.itemType === 'feed').reduce((sum, item) => sum + item.quantity, 0);
            const feedForecast = `Total feed logged: ${totalFeedQuantity} units. Forecast pending.`;
            const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.salePrice || 0), 0);
            
            document.getElementById('total-revenue').textContent = `GHS ${totalRevenue.toFixed(2)}`;
            document.getElementById('total-incidents').textContent = incidentsData.length;
            document.getElementById('total-inventory').textContent = deliveriesData.length;
            document.getElementById('mortality-trend').textContent = mortalityTrend;
            document.getElementById('feed-forecast').textContent = feedForecast;
            
            document.getElementById('report-total-revenue').textContent = `GHS ${totalRevenue.toFixed(2)}`;
            document.getElementById('report-total-incidents').textContent = incidentsData.length;
            document.getElementById('report-total-deliveries').textContent = deliveriesData.length;
        }

        function renderAdminList(items, containerId, renderer) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.length ? items.map(item => renderer(item)).join('') : `<p class="text-center text-gray-500">No data found.</p>`;
        }
        
        onSnapshot(collection(db, `artifacts/${appId}/public/data/orders`), (snapshot) => {
            salesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdminList(salesData, 'admin-orders-list', renderAdminOrder);
            updateAdminAnalytics();
        });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/incidents`), (snapshot) => {
            incidentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdminList(incidentsData, 'admin-incidents-list', renderAdminIncident);
            renderAdminList(incidentsData, 'regulator-incidents', renderAdminIncident);
            updateAdminAnalytics();
        });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/warehouse_deliveries`), (snapshot) => {
            deliveriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateAdminAnalytics();
        });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/sales`), (snapshot) => {
            salesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdminList(salesData, 'admin-sales-list', renderAdminSale);
            updateAdminAnalytics();
        });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/inventory`), (snapshot) => {
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdminList(logs, 'admin-inventory-list', renderAdminInventory);
        });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/batches`), (snapshot) => {
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            document.getElementById('regulator-traceability').innerHTML = logs.map(log => `<div class="list-item flex-col items-start"><p class="font-medium">Batch ID: ${log.id}</p><p class="text-xs">Coop: ${log.coopId}, Birds: ${log.birdCount}</p></div>`).join('');
        });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/assets`), (snapshot) => {
            const assets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            document.getElementById('admin-asset-list').innerHTML = assets.map(asset => `
                <div class="list-item flex-col items-start">
                    <span class="font-bold text-gray-800">${asset.name}</span>
                    <span class="text-sm text-gray-500">Type: ${asset.type}</span>
                    <span class="text-sm text-gray-500">Assigned to: ${asset.assignedTo || 'Unassigned'}</span>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full text-white ${asset.status === 'Available' ? 'bg-green-500' : 'bg-red-500'}">${asset.status}</span>
                </div>
            `).join('');
        });
        
        onSnapshot(collection(db, `artifacts/${appId}/public/data/warehouse_stock`), (snapshot) => {
            const stockItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const stockListHtml = stockItems.map(item => `
                <div class="list-item">
                    <span class="font-medium text-gray-700">${item.itemName} (${item.itemType})</span>
                    <span class="text-teal-600 font-semibold">${item.quantity} units</span>
                </div>
            `).join('');
            document.getElementById('warehouse-stock-list').innerHTML = stockListHtml || '<p class="text-gray-500">No stock items found.</p>';
            const dispatchDropdown = document.getElementById('dispatch-item-name');
            dispatchDropdown.innerHTML = '<option value="">-- Select an item --</option>' + stockItems.map(item => `<option value="${item.id}">${item.itemName} (${item.quantity} in stock)</option>`).join('');
        });
        
        onSnapshot(collection(db, `artifacts/${appId}/public/data/work_orders`), (snapshot) => {
            const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdminList(tasks, 'admin-task-list', renderAdminTask);
        });

        onSnapshot(collection(db, `artifacts/${appId}/public/data/ble_logs`), (snapshot) => {
            const bleLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            document.getElementById('ble-tracking-list').innerHTML = bleLogs.map(log => `
                <div class="list-item flex-col items-start">
                    <span class="font-bold text-gray-800">${log.deviceName}</span>
                    <span class="text-sm text-gray-500">User ID: ${log.userId}</span>
                    <span class="text-xs text-gray-400">Lat/Lng: ${log.latitude.toFixed(4)}, ${log.longitude.toFixed(4)}</span>
                    <span class="text-xs text-gray-400">Timestamp: ${log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'N/A'}</span>
                </div>
            `).join('');
        });

        // --- Staff App Logic ---
        const staffTabs = ['inventory', 'sales', 'incidents', 'assets', 'tasks'];
        staffTabs.forEach(tab => {
            document.getElementById(`staff-${tab}-tab`).onclick = () => {
                document.querySelectorAll('#staff-page .tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('#staff-page .tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`staff-${tab}-tab`).classList.add('active');
                document.getElementById(`staff-${tab}-panel`).classList.remove('hidden');
            };
        });

        onAuthStateChanged(auth, user => {
            if (user && !user.isAnonymous) {
                const inventoryRef = collection(db, `artifacts/${appId}/users/${user.uid}/inventory`);
                onSnapshot(query(inventoryRef), (snapshot) => {
                    const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderStaffList(logs, 'recent-inventory-list', log => `
                        <div class="bg-gray-50 rounded-lg p-3 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div>
                                <p class="font-medium text-gray-800">${log.itemName} (${log.itemType})</p>
                                <p class="text-sm text-gray-500">Coop ID: ${log.coopId}</p>
                            </div>
                            <p class="text-sm text-teal-600 font-semibold mt-2 sm:mt-0">${log.quantity} units</p>
                        </div>
                    `);
                });
                const assetsRef = collection(db, `artifacts/${appId}/public/data/assets`);
                onSnapshot(query(assetsRef, where('assignedTo', '==', user.uid)), (snapshot) => {
                    const assets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderStaffList(assets, 'staff-asset-list', asset => `
                        <div class="dashboard-card flex flex-col items-start">
                            <span class="text-lg font-bold text-gray-800">${asset.name}</span>
                            <span class="text-sm text-gray-500 mt-1">Type: ${asset.type}</span>
                            <span class="text-sm text-gray-500">Assigned to: ${asset.assignedTo || 'Unassigned'}</span>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full text-white ${asset.status === 'Available' ? 'bg-green-500' : 'bg-red-500'}">${asset.status}</span>
                        </div>
                    `);
                });
                const tasksRef = collection(db, `artifacts/${appId}/public/data/work_orders`);
                onSnapshot(query(tasksRef, where('assignedTo', '==', user.uid)), (snapshot) => {
                    const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderStaffList(tasks, 'staff-task-list', renderStaffTask);
                });
            }
        });

        function renderStaffList(items, containerId, renderer) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.length ? items.map(item => renderer(item)).join('') : `<p class="text-gray-500 text-center">No items found.</p>`;
        }

        const renderStaffTask = (task) => {
            const statusColor = task.status === 'Completed' ? 'bg-green-500' : 'bg-blue-500';
            return `
                <div class="dashboard-card flex flex-col items-start">
                    <div class="flex justify-between w-full">
                        <span class="text-lg font-bold text-gray-800">${task.title}</span>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white ${statusColor}">${task.status || 'Assigned'}</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${task.description}</p>
                    <p class="text-xs text-gray-400 mt-1">Due: ${task.dueDate}</p>
                    ${task.status !== 'Completed' ? `<button onclick="updateTaskStatus('${task.id}', 'Completed')" class="gradient-button mt-4 w-full text-sm py-2">Mark as Complete</button>` : ''}
                </div>
            `;
        };

        window.updateTaskStatus = async (taskId, newStatus) => {
            const taskRef = doc(db, `artifacts/${appId}/public/data/work_orders`, taskId);
            try {
                await updateDoc(taskRef, {
                    status: newStatus,
                    completedAt: serverTimestamp()
                });
                showModal('Success!', 'Task status updated successfully.');
            } catch (error) {
                console.error("Error updating task status:", error);
                showModal('Error', 'Failed to update task status. Please try again.');
            }
        };

        document.getElementById('inventory-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                coopId: document.getElementById('coop-id').value,
                itemType: document.getElementById('itemType').value,
                itemName: document.getElementById('itemName').value,
                quantity: parseInt(document.getElementById('quantity').value, 10),
                deliveryNotes: document.getElementById('deliveryNotes').value,
                timestamp: serverTimestamp(),
                userId: auth.currentUser.uid
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/inventory`), data);
                showModal('Success!', 'Inventory logged successfully.');
                document.getElementById('inventory-form').reset();
            } catch (error) {
                console.error("Error logging inventory: ", error);
                showModal('Error', 'Failed to log inventory. Please check the console.');
            }
        };

        document.getElementById('sales-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                saleItem: document.getElementById('saleItem').value,
                saleQuantity: parseInt(document.getElementById('saleQuantity').value, 10),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                saleNotes: document.getElementById('saleNotes').value,
                timestamp: serverTimestamp(),
                userId: auth.currentUser.uid
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/sales`), data);
                showModal('Success!', 'Sales logged successfully.');
                document.getElementById('sales-form').reset();
            } catch (error) {
                console.error("Error logging sales: ", error);
                showModal('Error', 'Failed to log sales. Please check the console.');
            }
        };

        document.getElementById('incidents-form').onsubmit = async (e) => {
            e.preventDefault();
            const photoFile = document.getElementById('incidentPhoto').files[0];
            const photoUrl = photoFile ? `https://storage.googleapis.com/your-bucket/incidents/${Date.now()}_${photoFile.name}` : null;
            const data = {
                incidentType: document.getElementById('incidentType').value,
                incidentTitle: document.getElementById('incidentTitle').value,
                incidentNotes: document.getElementById('incidentNotes').value,
                photoUrl: photoUrl,
                status: 'Pending',
                timestamp: serverTimestamp(),
                userId: auth.currentUser.uid
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/incidents`), data);
                showModal('Success!', 'Incident reported successfully. Photo upload simulated.');
                document.getElementById('incidents-form').reset();
            } catch (error) {
                console.error("Error reporting incident: ", error);
                showModal('Error', 'Failed to report incident. Please check the console.');
            }
        };

        // --- Public Portal Logic ---
        document.getElementById('marketplace-tab').onclick = () => {
            showPublicTab('marketplace');
            document.getElementById('order-form-container').classList.add('hidden');
        };
        document.getElementById('order-tracking-tab').onclick = () => showPublicTab('order-tracking');
        document.getElementById('traceability-tab').onclick = () => showPublicTab('traceability');

        function showPublicTab(tab) {
            document.querySelectorAll('#public-page .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#public-page .tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`public-${tab}-tab`).classList.add('active');
            document.getElementById(`public-${tab}-panel`).classList.remove('hidden');
        }

        document.getElementById('buy-birds').onclick = () => {
            document.getElementById('product').value = 'Birds';
            document.getElementById('order-form-container').classList.remove('hidden');
            document.getElementById('order-form-container').scrollIntoView({ behavior: 'smooth' });
        };
        document.getElementById('buy-eggs').onclick = () => {
            document.getElementById('product').value = 'Eggs';
            document.getElementById('order-form-container').classList.remove('hidden');
            document.getElementById('order-form-container').scrollIntoView({ behavior: 'smooth' });
        };
        
        document.getElementById('order-form').onsubmit = async (e) => {
            e.preventDefault();
            const orderData = {
                customerName: document.getElementById('customerName').value,
                customerEmail: document.getElementById('customerEmail').value,
                product: document.getElementById('product').value,
                quantity: parseInt(document.getElementById('quantity').value, 10),
                paymentMethod: document.getElementById('paymentMethod').value,
                status: 'Pending',
                deliveryHistory: [{ status: 'Order Submitted', timestamp: new Date() }],
                timestamp: new Date()
            };
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), orderData);
                const orderId = docRef.id;
                showModal('Order Submitted!', `Your order has been placed. Your Order ID is: <strong class="text-teal-600">${orderId}</strong>. Use this to track your order.`)
                document.getElementById('order-form').reset();
                document.getElementById('order-form-container').classList.add('hidden');
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('Order Failed', 'There was an error submitting your order. Please try again.');
            }
        };
        
        document.getElementById('track-order-button').onclick = async () => {
            const orderId = document.getElementById('order-id-input').value.trim();
            if (!orderId) {
                showModal('Input Required', 'Please enter your Order ID.');
                return;
            }
            document.getElementById('tracking-result').classList.add('hidden');
            document.getElementById('tracking-error').classList.add('hidden');
            try {
                const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('result-order-id').textContent = orderId;
                    document.getElementById('result-product').textContent = data.product;
                    document.getElementById('result-quantity').textContent = data.quantity;
                    document.getElementById('result-payment-method').textContent = data.paymentMethod;
                    document.getElementById('result-status').textContent = data.status;

                    const statusSpan = document.getElementById('result-status');
                    statusSpan.classList.remove('text-blue-500', 'text-green-500', 'text-orange-500');
                    if (data.status === 'Pending' || data.status === 'Processing') {
                        statusSpan.classList.add('text-orange-500');
                    } else if (data.status === 'Out for Delivery') {
                        statusSpan.classList.add('text-blue-500');
                    } else if (data.status === 'Delivered') {
                        statusSpan.classList.add('text-green-500');
                    }
                    
                    const historyList = document.getElementById('result-delivery-history');
                    historyList.innerHTML = '';
                    if (data.deliveryHistory && data.deliveryHistory.length > 0) {
                        data.deliveryHistory.forEach(step => {
                            const li = document.createElement('li');
                            li.textContent = `${step.timestamp.toDate().toLocaleString()}: ${step.status}`;
                            historyList.appendChild(li);
                        });
                    } else {
                        historyList.innerHTML = '<li>No delivery history available.</li>';
                    }
                    document.getElementById('tracking-result').classList.remove('hidden');
                } else {
                    document.getElementById('tracking-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching document:", error);
                showModal('Error', 'An error occurred while tracking your order. Check the console for details.');
            }
        };

        // --- Traceability Logic ---
        document.getElementById('batch-generator-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('batch-generator-form'));
            const data = Object.fromEntries(formData.entries());
            data.timestamp = serverTimestamp();
            data.userId = auth.currentUser.uid;
            
            const hashString = `${data.coopId}-${data.birdCount}-${data.feedType}-${new Date().toISOString()}-${Math.random()}`;
            data.blockchainHash = crypto.subtle ? 
                await crypto.subtle.digest('SHA-256', new TextEncoder().encode(hashString))
                .then(buffer => Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('')) :
                'simulated_hash_' + Math.random().toString(36).substring(2, 15);
            
            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/batches`), data);
                const batchId = docRef.id;
                document.getElementById('generated-batch-id').textContent = batchId;
                document.getElementById('generated-qr-code').classList.remove('hidden');
                showModal('Batch Generated!', `A new batch has been logged. The Batch ID is: <strong class="text-teal-600">${batchId}</strong>. This ID is linked to the blockchain hash for traceability.`);
                document.getElementById('batch-generator-form').reset();
            } catch (error) {
                console.error("Error adding batch document: ", error);
                showModal('Error', 'Failed to generate a new batch. Please check the console for details.');
            }
        };

        document.getElementById('copy-qr-code').onclick = () => {
            const batchId = document.getElementById('generated-batch-id').textContent;
            navigator.clipboard.writeText(batchId).then(() => {
                showModal('Copied!', 'Batch ID has been copied to your clipboard.');
            }).catch(err => {
                showModal('Copy Error', 'Could not copy to clipboard. Please select and copy the text manually.');
                console.error('Failed to copy text: ', err);
            });
        };

        document.getElementById('validate-batch-button').onclick = async () => {
            const batchId = document.getElementById('batch-id-input').value.trim();
            if (!batchId) {
                showModal('Input Required', 'Please enter a Batch ID.');
                return;
            }
            document.getElementById('validation-result').classList.add('hidden');
            document.getElementById('validation-error').classList.add('hidden');
            try {
                const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/batches`, batchId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('result-batch-id').textContent = batchId;
                    document.getElementById('result-coop-id').textContent = data.coopId;
                    document.getElementById('result-bird-count').textContent = data.birdCount;
                    document.getElementById('result-feed-type').textContent = data.feedType;
                    document.getElementById('result-blockchain-hash').textContent = data.blockchainHash;
                    document.getElementById('result-batch-notes').textContent = data.batchNotes;
                    document.getElementById('validation-result').classList.remove('hidden');
                } else {
                    document.getElementById('validation-error').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error validating batch:", error);
                showModal('Error', 'An error occurred during validation. Please check the console.');
            }
        };

        // --- Utility & Modal Logic ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modal.style.display = 'flex';
        }
        modalClose.onclick = () => { modal.style.display = 'none'; };

        // --- New Warehouse Forms Logic ---
        document.getElementById('warehouse-delivery-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                itemName: document.getElementById('warehouse-item-name').value,
                itemType: document.getElementById('warehouse-item-type').value,
                quantity: parseInt(document.getElementById('warehouse-quantity').value, 10),
                supplier: document.getElementById('warehouse-supplier').value,
                timestamp: serverTimestamp(),
                adminId: auth.currentUser.uid
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/warehouse_deliveries`), data);
                const stockRef = doc(db, `artifacts/${appId}/public/data/warehouse_stock`, data.itemName);
                const stockSnap = await getDoc(stockRef);
                if (stockSnap.exists()) {
                    await updateDoc(stockRef, { quantity: stockSnap.data().quantity + data.quantity, timestamp: serverTimestamp() });
                } else {
                    await setDoc(stockRef, { itemName: data.itemName, itemType: data.itemType, quantity: data.quantity, timestamp: serverTimestamp() });
                }
                showModal('Success!', 'Delivery logged and stock updated successfully.');
                document.getElementById('warehouse-delivery-form').reset();
            } catch (error) {
                console.error("Error logging delivery: ", error);
                showModal('Error', 'Failed to log delivery. Please check the console.');
            }
        };

        document.getElementById('dispatch-form').onsubmit = async (e) => {
            e.preventDefault();
            const itemName = document.getElementById('dispatch-item-name').value;
            const quantity = parseInt(document.getElementById('dispatch-quantity').value, 10);
            const staffUid = document.getElementById('dispatch-staff-uid').value;
            
            if (!itemName || !quantity || !staffUid) {
                showModal('Input Required', 'Please fill in all dispatch fields.');
                return;
            }
            try {
                const stockRef = doc(db, `artifacts/${appId}/public/data/warehouse_stock`, itemName);
                const stockSnap = await getDoc(stockRef);
                if (!stockSnap.exists() || stockSnap.data().quantity < quantity) {
                    showModal('Dispatch Failed', 'Not enough stock available for this item.');
                    return;
                }
                await updateDoc(stockRef, { quantity: stockSnap.data().quantity - quantity, timestamp: serverTimestamp() });
                const dispatchData = { itemName, quantity, staffUid, timestamp: serverTimestamp(), adminId: auth.currentUser.uid };
                await addDoc(collection(db, `artifacts/${appId}/public/data/dispatches`), dispatchData);
                const staffInventoryData = { itemName, itemType: stockSnap.data().itemType, quantity, coopId: 'Dispatch from Warehouse', deliveryNotes: `Dispatched from warehouse by admin ${auth.currentUser.uid}`, timestamp: serverTimestamp() };
                await addDoc(collection(db, `artifacts/${appId}/users/${staffUid}/inventory`), staffInventoryData);
                showModal('Dispatch Successful!', `${quantity} units of ${itemName} dispatched to staff member.`);
                document.getElementById('dispatch-form').reset();
            } catch (error) {
                console.error("Error dispatching item: ", error);
                showModal('Error', 'Failed to dispatch item. Please check the console.');
            }
        };
        
        // Report Generation Logic
        document.getElementById('download-pdf-report').onclick = () => {
            const doc = new jsPDF();
            doc.text("NSA Ecosystem Report", 10, 10);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 10, 20);

            let y = 30;
            doc.text("Sales Summary", 10, y += 10);
            const salesTable = salesData.map(sale => [
                sale.id, sale.saleItem, sale.saleQuantity, `GHS ${sale.salePrice.toFixed(2)}`,
                sale.timestamp ? new Date(sale.timestamp.toDate()).toLocaleDateString() : 'N/A'
            ]);
            doc.autoTable({ startY: y + 5, head: [['ID', 'Item', 'Quantity', 'Revenue', 'Date']], body: salesTable });

            y = doc.autoTable.previous.finalY + 10;
            doc.text("Incident Summary", 10, y);
            const incidentsTable = incidentsData.map(incident => [
                incident.id, incident.incidentTitle, incident.incidentType, incident.status,
                incident.timestamp ? new Date(incident.timestamp.toDate()).toLocaleDateString() : 'N/A'
            ]);
            doc.autoTable({ startY: y + 5, head: [['ID', 'Title', 'Type', 'Status', 'Date']], body: incidentsTable });

            doc.save("NSA_Report.pdf");
            showModal('Download Complete', 'PDF report has been generated and downloaded.');
        };

        document.getElementById('download-excel-report').onclick = () => {
            const reportData = [
                ["NSA Ecosystem Report"], [`Generated: ${new Date().toLocaleDateString()}`], [],
                ["Sales Summary"], ["ID", "Item", "Quantity", "Revenue", "Date"],
                ...salesData.map(sale => [sale.id, sale.saleItem, sale.saleQuantity, sale.salePrice, sale.timestamp ? new Date(sale.timestamp.toDate()).toLocaleDateString() : 'N/A']),
                [],
                ["Incident Summary"], ["ID", "Title", "Type", "Status", "Date"],
                ...incidentsData.map(incident => [incident.id, incident.incidentTitle, incident.incidentType, incident.status, incident.timestamp ? new Date(incident.timestamp.toDate()).toLocaleDateString() : 'N/A'])
            ];
            const ws = XLSX.utils.aoa_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, "NSA_Report.xlsx");
            showModal('Download Complete', 'Excel report has been generated and downloaded.');
        };
        
        document.getElementById('simulate-ble-data').onclick = async () => {
            const mockStaff = [{ id: "staff1", name: "Nana Yaw" }, { id: "staff2", name: "Aisha" }, { id: "staff3", name: "Kofi Mensah" }];
            const randomStaff = mockStaff[Math.floor(Math.random() * mockStaff.length)];
            const randomLat = 5.6148 + (Math.random() - 0.5) * 0.05;
            const randomLng = -0.1869 + (Math.random() - 0.5) * 0.05;
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/ble_logs`), {
                    deviceName: `${randomStaff.name}'s ID Card`, userId: randomStaff.id, latitude: randomLat, longitude: randomLng, timestamp: serverTimestamp()
                });
                showModal('BLE Log Simulated', `A new BLE location log for ${randomStaff.name} has been added.`);
            } catch (error) {
                console.error('Error simulating BLE data:', error);
                showModal('Error', 'Failed to simulate BLE data.');
            }
        };
    </script>
</body>
</html>
