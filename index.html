<!--
NSA Ecosystem Portal â€” Clean Ship + Roles Management
Single-file deliverable including:
1) Updated HTML/JS with fixes, role-based routing, Roles admin panel, Storage upload, PDF export fix, safer tab scoping
2) Cloud Functions (Admin SDK) for setUserRole (callable) â€” embedded below as reference
3) Firestore security rules sample â€” embedded below as reference

Notes:
- Replace firebaseConfig with your project values if different
- Deploy Functions and Rules as shown in the comments
- This is a drop-in replacement for your current index.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NSA Ecosystem Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f7f9fc; }
    .gradient-button{background:linear-gradient(135deg,#0d9488,#14b8a6);color:#fff;font-weight:700;padding:.75rem 1.5rem;border-radius:.5rem;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}
    .gradient-button:hover{transform:translateY(-2px);box-shadow:0 6px 8px rgba(0,0,0,.15)}
    input,select,textarea{background:#f1f5f9;border:1px solid #cbd5e0;border-radius:.5rem;padding:.75rem 1rem;transition:.2s}
    input:focus,select:focus,textarea:focus{border-color:#0d9488;box-shadow:0 0 0 3px rgba(13,148,136,.2);outline:none}
    .tab-button{flex:1;padding:12px;border-radius:9999px;font-weight:600;cursor:pointer;transition:.2s;text-align:center}
    .tab-button.active{background:#0d9488;color:#fff;box-shadow:0 4px 6px -1px rgba(13,148,136,.2),0 2px 4px -1px rgba(13,148,136,.12)}
    .tab-button:not(.active){background:#e2e8f0;color:#4a5568}
    .tab-button:hover:not(.active){background:#cbd5e0}
    .dashboard-card{background:#fff;border-radius:.75rem;box-shadow:0 4px 6px rgba(0,0,0,.1);padding:2rem;transition:transform .2s}
    .stat-box{background:#f0fdfa;border:1px solid #99f6e4;border-radius:.5rem;padding:1rem;text-align:center;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #e2e8f0;transition:background .2s}
    .list-item:hover{background:#f1f5f9}.list-item:last-child{border-bottom:none}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.4);justify-content:center;align-items:center}
    .modal-content{background:#fff;padding:2rem;border-radius:.75rem;width:90%;max-width:500px;box-shadow:0 10px 15px rgba(0,0,0,.1)}
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

  <div id="app-container" class="w-full max-w-5xl mx-auto flex flex-col items-center">

    <!-- LOGIN PAGE -->
    <div id="login-page" class="w-full max-w-sm">
      <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-sm">
        <h1 class="text-2xl font-bold text-center text-gray-800">NSA Ecosystem</h1>
        <p class="text-center text-sm text-gray-500 mt-2">Sign in to access your portal.</p>
        <form id="login-form" class="mt-8 space-y-6">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Email</label>
            <input type="email" id="email" placeholder="you@nsa.com" class="w-full" required />
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Password</label>
            <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full" required />
          </div>
          <button type="submit" class="gradient-button w-full">Sign In</button>
        </form>
        <div class="mt-4 text-center">
          <button id="google-login-button" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full w-full flex items-center justify-center space-x-2 hover:bg-gray-100">
            <span>Sign in with Google</span>
          </button>
        </div>
        <div class="mt-6 text-center text-sm text-gray-500">
          <p>Are you a customer or validator?</p>
          <button id="show-public-portal" class="text-teal-600 font-medium hover:underline">Access Public Portal</button>
        </div>
      </div>
    </div>

    <!-- ADMIN PAGE -->
    <div id="admin-page" class="hidden w-full max-w-5xl">
      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-5xl mb-4">
        <h1 class="text-3xl font-bold text-center text-gray-800">NSA Admin Dashboard</h1>
        <p class="text-center text-sm text-gray-500 mt-2">Real-time analytics and management.</p>
        <div class="mt-2 text-center text-xs text-gray-400">User ID: <span id="admin-user-id">Loading...</span></div>
        <div class="mt-2 text-center"><button id="admin-sign-out" class="text-sm text-teal-600 hover:underline">Sign Out</button></div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-5xl">
        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8" id="admin-tabs">
          <button id="admin-overview-tab" class="tab-button active">Overview</button>
          <button id="admin-inventory-tab" class="tab-button">Inventory</button>
          <button id="admin-sales-tab" class="tab-button">Sales</button>
          <button id="admin-incidents-tab" class="tab-button">Incidents</button>
          <button id="admin-traceability-tab" class="tab-button">Traceability</button>
          <button id="admin-training-tab" class="tab-button">Training</button>
          <button id="admin-regulator-tab" class="tab-button">Regulator</button>
          <button id="admin-warehouse-tab" class="tab-button">Warehouse</button>
          <button id="admin-assets-tab" class="tab-button">Assets</button>
          <button id="admin-reports-tab" class="tab-button">Reports</button>
          <button id="admin-tasks-tab" class="tab-button">Tasks</button>
          <button id="admin-orders-tab" class="tab-button">Orders</button>
          <button id="admin-ble-tracking-tab" class="tab-button">BLE Tracking</button>
          <button id="admin-roles-tab" class="tab-button">Roles</button>
        </div>

        <!-- Overview Panel -->
        <div id="admin-overview-panel" class="tab-content space-y-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="stat-box"><p class="text-sm font-medium text-gray-500">Total Sales Revenue</p><p id="total-revenue" class="mt-1 text-3xl font-bold text-emerald-600">GHS 0.00</p></div>
            <div class="stat-box"><p class="text-sm font-medium text-gray-500">Incidents Reported</p><p id="total-incidents" class="mt-1 text-3xl font-bold text-red-500">0</p></div>
            <div class="stat-box"><p class="text-sm font-medium text-gray-500">Inventory Logs</p><p id="total-inventory" class="mt-1 text-3xl font-bold text-sky-500">0</p></div>
          </div>
          <div class="dashboard-card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">AI Vet Analytics (Simulated)</h2>
            <div class="space-y-4">
              <div class="flex items-center space-x-4 p-4 rounded-lg bg-red-50">
                <div class="text-red-500">âš¡</div>
                <div><p class="text-gray-900 font-medium">Mortality Trend Analysis</p><p id="mortality-trend" class="text-gray-600 text-sm">Loading...</p></div>
              </div>
              <div class="flex items-center space-x-4 p-4 rounded-lg bg-teal-50">
                <div class="text-teal-500">ðŸ“¦</div>
                <div><p class="text-gray-900 font-medium">Feed Usage Forecast</p><p id="feed-forecast" class="text-gray-600 text-sm">Loading...</p></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Inventory -->
        <div id="admin-inventory-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Recent Inventory Logs</h2><div id="admin-inventory-list" class="space-y-2"><p class="text-center text-gray-500">Loading...</p></div></div>
        <!-- Sales -->
        <div id="admin-sales-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Recent Sales Logs</h2><div id="admin-sales-list" class="space-y-2"><p class="text-center text-gray-500">Loading...</p></div></div>
        <!-- Incidents -->
        <div id="admin-incidents-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Recent Incidents</h2><div id="admin-incidents-list" class="space-y-2"><p class="text-center text-gray-500">Loading...</p></div></div>
        <!-- Traceability -->
        <div id="admin-traceability-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Generate Traceable Batch</h2>
          <form id="batch-generator-form" class="space-y-6">
            <div><label class="block text-gray-700 font-medium mb-2">Coop ID</label><input id="coopId" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Bird Count</label><input type="number" id="birdCount" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Feed Type</label><input id="feedType" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Batch Notes</label><textarea id="batchNotes" rows="3" class="w-full"></textarea></div>
            <button class="gradient-button w-full">Generate Traceable Batch</button>
          </form>
          <div id="generated-qr-code" class="mt-8 hidden p-6 bg-gray-50 rounded-lg shadow-inner text-center">
            <h3 class="font-bold text-gray-700">Generated Batch ID</h3>
            <p id="generated-batch-id" class="text-xl font-mono text-teal-600 my-2 break-all"></p>
            <p class="text-sm text-gray-500">Copy this ID to generate a physical QR code for the batch.</p>
            <button id="copy-qr-code" class="mt-4 text-sm text-teal-600 hover:underline">Copy to Clipboard</button>
          </div>
        </div>
        <!-- Training -->
        <div id="admin-training-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Manage Training & Students</h2>
          <form id="training-form" class="space-y-4">
            <div><label class="block text-gray-700 font-medium mb-2">Training Material Title</label><input id="material-title" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Video/PDF Link</label><input id="material-link" class="w-full" required /></div>
            <button class="gradient-button w-full">Upload Material</button>
          </form>
          <div class="mt-8"><h3 class="text-lg font-semibold text-gray-700">Student Progress Tracker (Mock)</h3><div id="student-list" class="mt-4 space-y-2"><p class="text-gray-500 text-center">No students enrolled yet.</p></div></div>
        </div>
        <!-- Regulator -->
        <div id="admin-regulator-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Regulator & Audit Access (Read-Only)</h2>
          <div class="mt-8 space-y-4">
            <h3 class="font-semibold text-gray-700">All Incident Logs</h3>
            <div id="regulator-incidents" class="space-y-2"><p class="text-gray-500 text-center">Loading...</p></div>
            <h3 class="font-semibold text-gray-700 mt-6">All Traceability Logs</h3>
            <div id="regulator-traceability" class="space-y-2"><p class="text-gray-500 text-center">Loading...</p></div>
          </div>
        </div>
        <!-- Warehouse -->
        <div id="admin-warehouse-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Warehouse Management</h2>
          <div class="dashboard-card mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Log Incoming Delivery</h3>
            <form id="warehouse-delivery-form" class="space-y-4">
              <div><label class="block text-gray-700 font-medium mb-2">Item Name</label><input id="warehouse-item-name" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Item Type</label><select id="warehouse-item-type" class="w-full"><option value="feed">Feed</option><option value="medicine">Medicine</option><option value="vaccine">Vaccine</option><option value="other">Other</option></select></div>
              <div><label class="block text-gray-700 font-medium mb-2">Quantity</label><input type="number" id="warehouse-quantity" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Supplier</label><input id="warehouse-supplier" class="w-full" /></div>
              <button class="gradient-button w-full">Log Delivery</button>
            </form>
          </div>
          <div class="dashboard-card">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Dispatch Inventory to Staff</h3>
            <div class="space-y-4">
              <h4 class="font-medium text-gray-700">Current Stock Levels</h4>
              <div id="warehouse-stock-list" class="space-y-2"><p class="text-gray-500">Loading stock data...</p></div>
            </div>
            <form id="dispatch-form" class="space-y-4 mt-8">
              <div><label class="block text-gray-700 font-medium mb-2">Item to Dispatch</label><select id="dispatch-item-name" class="w-full" required><option value="">-- Select an item --</option></select></div>
              <div><label class="block text-gray-700 font-medium mb-2">Quantity</label><input type="number" id="dispatch-quantity" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Recipient Staff UID</label><input id="dispatch-staff-uid" class="w-full" required /></div>
              <button class="gradient-button w-full">Dispatch Item</button>
            </form>
          </div>
        </div>
        <!-- Assets -->
        <div id="admin-assets-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Asset Management</h2>
          <div class="dashboard-card mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Add New Asset</h3>
            <form id="add-asset-form" class="space-y-4">
              <div><label class="block text-gray-700 font-medium mb-2">Asset Name</label><input id="asset-name" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Asset Type</label><input id="asset-type" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Assigned To (Staff UID)</label><input id="asset-assigned-to" class="w-full" /></div>
              <button class="gradient-button w-full">Add Asset</button>
            </form>
          </div>
          <div class="dashboard-card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Current Asset Status</h3><div id="admin-asset-list" class="space-y-2"><p class="text-gray-500">Loading asset data...</p></div></div>
        </div>
        <!-- Reports -->
        <div id="admin-reports-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Reports & Analytics</h2>
          <div class="dashboard-card mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Key Metrics Summary</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div class="stat-box"><p class="text-sm font-medium text-gray-500">Total Sales Revenue</p><p id="report-total-revenue" class="mt-1 text-3xl font-bold text-emerald-600">GHS 0.00</p></div>
              <div class="stat-box"><p class="text-sm font-medium text-gray-500">Incidents Reported</p><p id="report-total-incidents" class="mt-1 text-3xl font-bold text-red-500">0</p></div>
              <div class="stat-box"><p class="text-sm font-medium text-gray-500">Total Deliveries</p><p id="report-total-deliveries" class="mt-1 text-3xl font-bold text-sky-500">0</p></div>
            </div>
          </div>
          <div class="dashboard-card">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Download Reports</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button id="download-pdf-report" class="gradient-button">Download PDF Report</button>
              <button id="download-excel-report" class="gradient-button">Download Excel Report</button>
            </div>
          </div>
        </div>
        <!-- Tasks -->
        <div id="admin-tasks-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Task Assignment</h2>
          <div class="dashboard-card mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Assign a New Task</h3>
            <form id="assign-task-form" class="space-y-4">
              <div><label class="block text-gray-700 font-medium mb-2">Task Title</label><input id="task-title" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Description</label><textarea id="task-description" rows="3" class="w-full" required></textarea></div>
              <div><label class="block text-gray-700 font-medium mb-2">Assigned To (Staff UID)</label><input id="task-assigned-to" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Due Date</label><input type="date" id="task-due-date" class="w-full" /></div>
              <button class="gradient-button w-full">Assign Task</button>
            </form>
          </div>
          <div class="dashboard-card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Current Tasks</h3><div id="admin-task-list" class="space-y-2"><p class="text-gray-500">Loading task data...</p></div></div>
        </div>
        <!-- Orders -->
        <div id="admin-orders-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Customer Orders</h2><div id="admin-orders-list" class="space-y-4"><p class="text-gray-500 text-center">No orders found.</p></div></div>
        <!-- BLE -->
        <div id="admin-ble-tracking-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Live BLE Staff Tracking (Simulated)</h2><div class="dashboard-card"><h3 class="text-lg font-semibold text-gray-700 mb-4">Live Location Feed</h3><div id="ble-tracking-list" class="space-y-4"><p class="text-gray-500">Awaiting BLE logs...</p></div><button id="simulate-ble-data" class="gradient-button mt-4 w-full text-sm">Simulate New BLE Log</button></div></div>
        <!-- Roles -->
        <div id="admin-roles-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Roles Management</h2>
          <div class="dashboard-card">
            <form id="set-role-form" class="space-y-4">
              <div><label class="block text-gray-700 font-medium mb-2">User Email</label><input id="role-email" type="email" class="w-full" placeholder="user@example.com" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Role</label>
                <select id="role-value" class="w-full" required>
                  <option value="admin">admin</option>
                  <option value="staff">staff</option>
                  <option value="customer">customer</option>
                </select>
              </div>
              <button class="gradient-button w-full">Set Role</button>
            </form>
            <p class="text-xs text-gray-500 mt-4">This uses a Firebase Callable Function (Admin SDK) to set a custom claim and mirror a roles/{uid} doc.</p>
          </div>
        </div>

      </div>
    </div>

    <!-- STAFF PAGE -->
    <div id="staff-page" class="hidden w-full max-w-2xl">
      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl mb-4">
        <h1 class="text-2xl font-bold text-center text-gray-800">Field Staff App</h1>
        <div class="mt-2 text-center text-xs text-gray-400">User ID: <span id="staff-user-id">Loading...</span></div>
        <div class="mt-2 text-center"><button id="staff-sign-out" class="text-sm text-teal-600 hover:underline">Sign Out</button></div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
        <div class="flex justify-center space-x-2 mb-8" id="staff-tabs">
          <button id="staff-inventory-tab" class="tab-button active">Inventory</button>
          <button id="staff-sales-tab" class="tab-button">Sales</button>
          <button id="staff-incidents-tab" class="tab-button">Incidents</button>
          <button id="staff-assets-tab" class="tab-button">Assets</button>
          <button id="staff-tasks-tab" class="tab-button">Tasks</button>
        </div>
        <div id="staff-inventory-panel" class="tab-content space-y-6">
          <h2 class="text-xl font-semibold text-gray-700 text-center">Log Inventory Delivery</h2>
          <form id="inventory-form" class="space-y-6">
            <div><label class="block text-gray-700 font-medium mb-2">Coop ID</label><input id="coop-id" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Item Type</label><select id="itemType" class="w-full"><option value="feed">Feed</option><option value="medicine">Medicine</option><option value="vaccine">Vaccine</option><option value="other">Other</option></select></div>
            <div><label class="block text-gray-700 font-medium mb-2">Item Name</label><input id="itemName" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Quantity</label><input type="number" id="quantity" class="w-full" required /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Delivery Notes</label><textarea id="deliveryNotes" rows="3" class="w-full"></textarea></div>
            <button class="gradient-button w-full">Log Inventory</button>
          </form>
          <div class="mt-8"><h3 class="text-lg font-semibold text-gray-700">Recent Deliveries</h3><div id="recent-inventory-list" class="mt-4 space-y-2"><p class="text-gray-500 text-center">No recent deliveries logged.</p></div></div>
        </div>
        <div id="staff-sales-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Track Sales</h2>
          <form id="sales-form" class="space-y-6">
            <div><label class="block text-gray-700 font-medium mb-2">Item Sold</label><select id="saleItem" class="w-full"><option value="birds">Birds</option><option value="eggs">Eggs</option></select></div>
            <div><label class="block text-gray-700 font-medium mb-2">Quantity</label><input type="number" id="saleQuantity" class="w-full" /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Total Revenue (GHS)</label><input type="number" id="salePrice" step="0.01" class="w-full" /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Sale Notes</label><textarea id="saleNotes" rows="3" class="w-full"></textarea></div>
            <button class="gradient-button w-full">Log Sales</button>
          </form>
        </div>
        <div id="staff-incidents-panel" class="tab-content hidden">
          <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Report Incident</h2>
          <form id="incidents-form" class="space-y-6">
            <div><label class="block text-gray-700 font-medium mb-2">Incident Type</label><select id="incidentType" class="w-full"><option value="mortality">Mortality</option><option value="disease">Disease Outbreak</option><option value="supply">Supply Shortage</option></select></div>
            <div><label class="block text-gray-700 font-medium mb-2">Incident Title</label><input id="incidentTitle" class="w-full" /></div>
            <div><label class="block text-gray-700 font-medium mb-2">Description</label><textarea id="incidentNotes" rows="5" class="w-full"></textarea></div>
            <div><label class="block text-gray-700 font-medium mb-2">Photo Upload</label><input type="file" id="incidentPhoto" accept="image/*" class="w-full" /></div>
            <button class="gradient-button w-full">Report Incident</button>
          </form>
        </div>
        <div id="staff-assets-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">My Assigned Assets</h2><div id="staff-asset-list" class="space-y-4"><p class="text-gray-500 text-center">No assets assigned.</p></div></div>
        <div id="staff-tasks-panel" class="tab-content hidden"><h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">My Work Orders</h2><div id="staff-task-list" class="space-y-4"><p class="text-gray-500 text-center">No tasks assigned.</p></div></div>
      </div>
    </div>

    <!-- PUBLIC PAGE -->
    <div id="public-page" class="hidden w-full max-w-4xl">
      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl mb-4">
        <h1 class="text-3xl font-bold text-center text-gray-800">NSA Customer Portal</h1>
        <div class="mt-2 text-center text-xs text-gray-400">User ID: <span id="customer-user-id">Loading...</span></div>
        <div class="mt-2 text-center"><button id="show-login-portal" class="text-sm text-teal-600 hover:underline">Internal Sign-in</button></div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl">
        <div class="flex justify-center space-x-2 md:space-x-4 mb-8" id="public-tabs">
          <button id="marketplace-tab" class="tab-button active">Marketplace</button>
          <button id="order-tracking-tab" class="tab-button">Track Order</button>
          <button id="traceability-tab" class="tab-button">Traceability</button>
        </div>
        <div id="marketplace-panel" class="tab-content space-y-8">
          <div class="relative w-full h-72 rounded-xl overflow-hidden shadow-lg bg-gray-200 flex items-center justify-center text-gray-600">Hero</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card p-6 bg-white rounded-xl shadow-lg"><h3 class="text-xl font-bold text-gray-800">Live Birds</h3><p class="text-gray-500 mt-1">Healthy birds.</p><button id="buy-birds" class="gradient-button mt-4 w-full">Order Now</button></div>
            <div class="card p-6 bg-white rounded-xl shadow-lg"><h3 class="text-xl font-bold text-gray-800">Fresh Eggs</h3><p class="text-gray-500 mt-1">Farm-fresh eggs.</p><button id="buy-eggs" class="gradient-button mt-4 w-full">Order Now</button></div>
          </div>
          <div id="order-form-container" class="mt-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 text-center mb-6">Place Your Order</h2>
            <form id="order-form" class="space-y-6">
              <div><label class="block text-gray-700 font-medium mb-2">Your Name</label><input id="customerName" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Email</label><input id="customerEmail" type="email" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Product</label><input id="product" class="w-full bg-gray-200" readonly required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Quantity</label><input id="quantity" type="number" class="w-full" required /></div>
              <div><label class="block text-gray-700 font-medium mb-2">Payment Method</label><select id="paymentMethod" class="w-full"><option value="memo">Memo</option><option value="bank-transfer">Bank Transfer</option><option value="card">Card</option></select></div>
              <button class="gradient-button w-full">Submit Order Request</button>
            </form>
          </div>
        </div>
        <div id="order-tracking-panel" class="tab-content hidden">
          <h2 class="text-2xl font-semibold text-gray-700 text-center mb-6">Track Your Order</h2>
          <div class="space-y-4"><div><label class="block text-gray-700 font-medium mb-2">Order ID</label><input id="order-id-input" class="w-full" /></div><button id="track-order-button" class="gradient-button w-full">Track Order</button></div>
          <div id="tracking-result" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner hidden">
            <h3 class="text-xl font-semibold text-center mb-4 text-emerald-600">Order Details</h3>
            <div class="space-y-2 text-gray-700">
              <div class="flex justify-between"><span class="font-medium">Order ID:</span><span id="result-order-id"></span></div>
              <div class="flex justify-between"><span class="font-medium">Product:</span><span id="result-product"></span></div>
              <div class="flex justify-between"><span class="font-medium">Quantity:</span><span id="result-quantity"></span></div>
              <div class="flex justify-between"><span class="font-medium">Payment Method:</span><span id="result-payment-method" class="text-sm text-right"></span></div>
              <div class="flex justify-between"><span class="font-medium">Current Status:</span><span id="result-status" class="font-bold text-blue-500"></span></div>
              <div class="items-start"><span class="font-medium">Delivery History:</span><ul id="result-delivery-history" class="list-disc list-inside text-sm text-gray-600 ml-4"></ul></div>
            </div>
          </div>
          <div id="tracking-error" class="mt-8 p-6 bg-red-50 text-red-700 border border-red-200 rounded-lg hidden"><p class="text-center font-medium">Order not found.</p></div>
        </div>
        <div id="traceability-panel" class="tab-content hidden">
          <h2 class="text-2xl font-semibold text-gray-700 text-center mb-6">Validate Product Traceability</h2>
          <div class="space-y-4"><div><label class="block text-gray-700 font-medium mb-2">Batch ID</label><input id="batch-id-input" class="w-full" /></div><button id="validate-batch-button" class="gradient-button w-full">Validate Batch</button></div>
          <div id="validation-result" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner hidden">
            <h3 class="text-xl font-semibold text-center mb-4 text-emerald-600">Batch Details</h3>
            <div class="space-y-2 text-gray-700">
              <div class="flex justify-between"><span class="font-medium">Batch ID:</span><span id="result-batch-id"></span></div>
              <div class="flex justify-between"><span class="font-medium">Coop ID:</span><span id="result-coop-id"></span></div>
              <div class="flex justify-between"><span class="font-medium">Bird Count:</span><span id="result-bird-count"></span></div>
              <div class="flex justify-between"><span class="font-medium">Feed Type:</span><span id="result-feed-type"></span></div>
              <div class="items-start"><span class="font-medium">Hash:</span><span id="result-blockchain-hash" class="text-xs font-mono text-gray-600 break-all text-right"></span></div>
              <div class="items-start"><span class="font-medium">Notes:</span><span id="result-batch-notes" class="text-xs text-gray-600 text-right"></span></div>
            </div>
          </div>
          <div id="validation-error" class="mt-8 p-6 bg-red-50 text-red-700 border border-red-200 rounded-lg hidden"><p class="text-center font-medium">Batch not found.</p></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-8 text-center text-gray-500 text-sm"><p>powered by MulticomIOT</p></footer>

  <!-- Modal -->
  <div id="modal" class="modal"><div class="modal-content"><h3 id="modal-title" class="text-xl font-bold mb-2"></h3><p id="modal-message" class="text-gray-700 mb-4"></p><button id="modal-close" class="gradient-button w-full">OK</button></div></div>

  <!-- Firebase + libs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, addDoc, collection, doc, getDoc, onSnapshot, query, where, serverTimestamp, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-functions.js";

    import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js";
    import autoTable from "https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js";
    import "https://unpkg.com/xlsx/dist/xlsx.full.min.js";

    // CONFIG
    const appId = 'nsa-miot';
    const firebaseConfig = {
      apiKey: "AIzaSyDDbxNeMpLncUVPJtmtsFzNq0zLA9nHB_U",
      authDomain: "nsa-miot.firebaseapp.com",
      projectId: "nsa-miot",
      storageBucket: "nsa-miot.firebasestorage.app",
      messagingSenderId: "1078189349427",
      appId: "1:1078189349427:web:9c4d6503c71da21fd2a146",
      measurementId: "G-9RFX2052QE"
    };

    // INIT
    let app, auth, db, storage, functions;
    try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); storage = getStorage(app); functions = getFunctions(app); }
    catch(e){ console.error('Firebase init failed', e); showModal('Initialization Error', 'Failed to initialize Firebase.'); }

    // Elements
    const loginPage = document.getElementById('login-page');
    const adminPage = document.getElementById('admin-page');
    const staffPage = document.getElementById('staff-page');
    const publicPage = document.getElementById('public-page');

    function showPage(name){ [loginPage,adminPage,staffPage,publicPage].forEach(p=>p.classList.add('hidden')); ({login:loginPage,admin:adminPage,staff:staffPage,public:publicPage}[name]).classList.remove('hidden'); }

    // Modal utils
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    document.getElementById('modal-close').onclick = () => modal.style.display='none';
    function showModal(title, html){ modalTitle.textContent=title; modalMessage.innerHTML=html; modal.style.display='flex'; }

    // Auth gate with roles via custom claims
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showPage('login'); return; }
      try{
        const token = await user.getIdTokenResult(true);
        const role = token.claims.role; // 'admin'|'staff'|undefined
        if(role==='admin'){ document.getElementById('admin-user-id').textContent=user.uid; showPage('admin'); }
        else if(role==='staff'){ document.getElementById('staff-user-id').textContent=user.uid; showPage('staff'); }
        else if(user.isAnonymous){ document.getElementById('customer-user-id').textContent=user.uid; showPage('public'); }
        else { await signOut(auth); showModal('Access Denied','Your account does not have access to an internal portal.'); showPage('login'); }
      }catch(err){ console.error(err); showPage('login'); }
    });

    // Login actions
    document.getElementById('login-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); const email=emailInput.value.trim(); const pw=passwordInput.value;
      try{ await signInWithEmailAndPassword(auth,email,pw); }catch(err){ console.error(err); showModal('Login Failed','Invalid email or password.'); }
    });
    const emailInput=document.getElementById('email'); const passwordInput=document.getElementById('password');
    document.getElementById('google-login-button').onclick=async()=>{ try{ await signInWithPopup(auth,new GoogleAuthProvider()); }catch(err){ console.error(err); showModal('Google Login Failed','Try again.'); } };
    document.getElementById('show-public-portal').onclick=()=> signInAnonymously(auth).catch(err=>{ console.error(err); showModal('Authentication Failed','Could not sign in anonymously.'); });
    document.getElementById('admin-sign-out').onclick=()=>signOut(auth);
    document.getElementById('staff-sign-out').onclick=()=>signOut(auth);
    document.getElementById('show-login-portal').onclick=()=>signOut(auth);

    // Scoped tab switching
    function wireTabs(containerId, prefix){
      const container=document.getElementById(containerId);
      container.querySelectorAll('.tab-button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          container.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
          container.parentElement.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
          btn.classList.add('active');
          const targetId = btn.id.replace(`${prefix}-`,``) + '-panel';
          document.getElementById(`${prefix}-${targetId}`).classList.remove('hidden');
        });
      });
    }
    wireTabs('admin-tabs','admin');
    wireTabs('staff-tabs','staff');
    wireTabs('public-tabs','');

    // Public tabs (fix id mismatch)
    function showPublicTab(tab){
      const container=document.getElementById('public-page');
      container.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      container.querySelectorAll('.tab-content').forEach(p=>p.classList.add('hidden'));
      document.getElementById(`${tab}-tab`).classList.add('active');
      document.getElementById(`${tab}-panel`).classList.remove('hidden');
    }
    document.getElementById('marketplace-tab').onclick=()=>{ showPublicTab('marketplace'); orderFormContainer.classList.add('hidden'); };
    document.getElementById('order-tracking-tab').onclick=()=> showPublicTab('order-tracking');
    document.getElementById('traceability-tab').onclick=()=> showPublicTab('traceability');

    // Datasets
    let ordersData=[], salesData=[], incidentsData=[], deliveriesData=[];

    // Helpers
    function toLocalStringSafe(ts){ if(!ts) return 'N/A'; const d= ts.toDate? ts.toDate() : (ts instanceof Date? ts:null); return d? d.toLocaleString(): 'N/A'; }
    function requireAuth(){ if(!auth.currentUser){ showModal('Not signed in','Please sign in to continue.'); return false; } return true; }

    function renderList(items, containerId, renderer){ const el=document.getElementById(containerId); el.innerHTML = items.length? items.map(renderer).join('') : '<p class="text-center text-gray-500">No data found.</p>'; }

    // Snapshots
    const col = (path)=>collection(db, path);
    onSnapshot(col(`artifacts/${appId}/public/data/orders`),(snap)=>{ ordersData=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(ordersData,'admin-orders-list', renderAdminOrder); updateAdminAnalytics(); });
    onSnapshot(col(`artifacts/${appId}/public/data/sales`),(snap)=>{ salesData=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(salesData,'admin-sales-list', renderAdminSale); updateAdminAnalytics(); });
    onSnapshot(col(`artifacts/${appId}/public/data/incidents`),(snap)=>{ incidentsData=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(incidentsData,'admin-incidents-list', renderAdminIncident); renderList(incidentsData,'regulator-incidents', renderAdminIncident); updateAdminAnalytics(); });
    onSnapshot(col(`artifacts/${appId}/public/data/warehouse_deliveries`),(snap)=>{ deliveriesData=snap.docs.map(d=>({id:d.id,...d.data()})); updateAdminAnalytics(); });
    onSnapshot(col(`artifacts/${appId}/public/data/inventory`),(snap)=>{ const logs=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(logs,'admin-inventory-list', renderAdminInventory); });
    onSnapshot(col(`artifacts/${appId}/public/data/batches`),(snap)=>{ const logs=snap.docs.map(d=>({id:d.id,...d.data()})); document.getElementById('regulator-traceability').innerHTML = logs.map(l=>`<div class='list-item flex-col items-start'><p class='font-medium'>Batch ID: ${l.id}</p><p class='text-xs'>Coop: ${l.coopId}, Birds: ${l.birdCount}</p></div>`).join(''); });
    onSnapshot(col(`artifacts/${appId}/public/data/assets`),(snap)=>{ const assets=snap.docs.map(d=>({id:d.id,...d.data()})); document.getElementById('admin-asset-list').innerHTML = assets.map(a=>`<div class='list-item flex-col items-start'><span class='font-bold text-gray-800'>${a.name}</span><span class='text-sm text-gray-500'>Type: ${a.type}</span><span class='text-sm text-gray-500'>Assigned to: ${a.assignedTo||'Unassigned'}</span><span class='text-xs font-semibold px-2 py-1 rounded-full text-white ${a.status==='Available'?'bg-green-500':'bg-red-500'}'>${a.status||'Available'}</span></div>`).join(''); });
    onSnapshot(col(`artifacts/${appId}/public/data/warehouse_stock`),(snap)=>{ const items=snap.docs.map(d=>({id:d.id,...d.data()})); const listHtml = items.map(i=>`<div class='list-item'><span class='font-medium text-gray-700'>${i.itemName} (${i.itemType})</span><span class='text-teal-600 font-semibold'>${i.quantity} units</span></div>`).join(''); document.getElementById('warehouse-stock-list').innerHTML = listHtml || '<p class="text-gray-500">No stock items found.</p>'; const dd=document.getElementById('dispatch-item-name'); dd.innerHTML='<option value="">-- Select an item --</option>'+ items.map(i=>`<option value='${i.id}'>${i.itemName} (${i.quantity} in stock)</option>`).join(''); });
    onSnapshot(col(`artifacts/${appId}/public/data/work_orders`),(snap)=>{ const tasks=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(tasks,'admin-task-list', renderAdminTask); });
    onSnapshot(col(`artifacts/${appId}/public/data/ble_logs`),(snap)=>{ const logs=snap.docs.map(d=>({id:d.id,...d.data()})); document.getElementById('ble-tracking-list').innerHTML = logs.map(l=>`<div class='list-item flex-col items-start'><span class='font-bold text-gray-800'>${l.deviceName}</span><span class='text-sm text-gray-500'>User ID: ${l.userId}</span><span class='text-xs text-gray-400'>Lat/Lng: ${Number(l.latitude).toFixed(4)}, ${Number(l.longitude).toFixed(4)}</span><span class='text-xs text-gray-400'>Timestamp: ${toLocalStringSafe(l.timestamp)}</span></div>`).join(''); });

    // Staff listeners (private)
    onAuthStateChanged(auth, user=>{
      if(user && !user.isAnonymous){
        const invRef = collection(db, `artifacts/${appId}/users/${user.uid}/inventory`);
        onSnapshot(query(invRef),(snap)=>{ const logs=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(logs,'recent-inventory-list', log=>`<div class='bg-gray-50 rounded-lg p-3 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center'><div><p class='font-medium text-gray-800'>${log.itemName} (${log.itemType})</p><p class='text-sm text-gray-500'>Coop ID: ${log.coopId}</p></div><p class='text-sm text-teal-600 font-semibold mt-2 sm:mt-0'>${log.quantity} units</p></div>`); });
        const assetsRef = collection(db, `artifacts/${appId}/public/data/assets`);
        onSnapshot(query(assetsRef, where('assignedTo','==',user.uid)),(snap)=>{ const as=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(as,'staff-asset-list', a=>`<div class='dashboard-card flex flex-col items-start'><span class='text-lg font-bold text-gray-800'>${a.name}</span><span class='text-sm text-gray-500 mt-1'>Type: ${a.type}</span><span class='text-sm text-gray-500'>Assigned to: ${a.assignedTo||'Unassigned'}</span><span class='text-xs font-semibold px-2 py-1 rounded-full text-white ${a.status==='Available'?'bg-green-500':'bg-red-500'}'>${a.status||'Available'}</span></div>`); });
        const tasksRef = collection(db, `artifacts/${appId}/public/data/work_orders`);
        onSnapshot(query(tasksRef, where('assignedTo','==',user.uid)),(snap)=>{ const ts=snap.docs.map(d=>({id:d.id,...d.data()})); renderList(ts,'staff-task-list', renderStaffTask); });
      }
    });

    // Renderers
    function renderAdminOrder(o){ return `<div class='list-item flex-col items-start'><span class='font-bold text-gray-800'>${o.product} Ã— ${o.quantity}</span><span class='text-sm text-gray-500'>${o.customerName} â€¢ ${o.customerEmail}</span><span class='text-xs text-gray-400'>${toLocalStringSafe(o.timestamp)} â€¢ ${o.status}</span></div>`; }
    function renderAdminSale(s){ return `<div class='list-item flex-col items-start'><span class='font-bold text-gray-800'>${s.saleItem} Ã— ${s.saleQuantity}</span><span class='text-sm text-gray-500'>GHS ${(Number(s.salePrice)||0).toFixed(2)}</span><span class='text-xs text-gray-400'>${toLocalStringSafe(s.timestamp)}</span></div>`; }
    function renderAdminIncident(i){ return `<div class='list-item flex-col items-start'><span class='font-bold text-gray-800'>${i.incidentTitle||i.incidentType}</span><span class='text-sm text-gray-500'>${i.incidentType} â€¢ ${i.status}</span><span class='text-xs text-gray-400'>${toLocalStringSafe(i.timestamp)}</span></div>`; }
    function renderAdminInventory(l){ return `<div class='list-item'><span class='font-medium text-gray-700'>${l.itemName} (${l.itemType})</span><span class='text-teal-600 font-semibold'>${l.quantity} units</span></div>`; }
    function renderAdminTask(t){ const c=t.status==='Completed'?'bg-green-500':'bg-blue-500'; return `<div class='list-item flex-col items-start'><div class='flex justify-between w-full'><span class='text-lg font-bold text-gray-800'>${t.title}</span><span class='text-xs font-semibold px-2 py-1 rounded-full text-white ${c}'>${t.status||'Assigned'}</span></div><p class='text-sm text-gray-500 mt-1'>${t.description}</p><p class='text-xs text-gray-400 mt-1'>Due: ${t.dueDate||'â€”'}</p>${t.status!=='Completed'?`<button class='gradient-button mt-3 w-full text-sm' onclick="updateTaskStatus('${t.id}','Completed')">Mark as Complete</button>`:''}</div>`; }
    function renderStaffTask(t){ const c=t.status==='Completed'?'bg-green-500':'bg-blue-500'; return `<div class='dashboard-card flex flex-col items-start'><div class='flex justify-between w-full'><span class='text-lg font-bold text-gray-800'>${t.title}</span><span class='text-xs font-semibold px-2 py-1 rounded-full text-white ${c}'>${t.status||'Assigned'}</span></div><p class='text-sm text-gray-500 mt-1'>${t.description}</p><p class='text-xs text-gray-400 mt-1'>Due: ${t.dueDate||'â€”'}</p>${t.status!=='Completed'?`<button class='gradient-button mt-4 w-full text-sm' onclick="updateTaskStatus('${t.id}','Completed')">Mark as Complete</button>`:''}</div>`; }

    // Analytics updater
    function updateAdminAnalytics(){
      const totalRevenue = salesData.reduce((s,x)=> s + (Number(x.salePrice)||0), 0);
      const mortalityCount = incidentsData.filter(i=>i.incidentType==='mortality').length;
      const mortalityTrend = mortalityCount>5? 'High mortality detected. Immediate action required.' : 'Mortality is within normal range.';
      const totalFeedQty = deliveriesData.filter(i=>i.itemType==='feed').reduce((s,it)=> s + (Number(it.quantity)||0), 0);
      const feedForecast = `Total feed logged: ${totalFeedQty} units. Forecast pending.`;
      document.getElementById('total-revenue').textContent = `GHS ${totalRevenue.toFixed(2)}`;
      document.getElementById('total-incidents').textContent = incidentsData.length;
      document.getElementById('total-inventory').textContent = deliveriesData.length;
      document.getElementById('mortality-trend').textContent = mortalityTrend;
      document.getElementById('feed-forecast').textContent = feedForecast;
      document.getElementById('report-total-revenue').textContent = `GHS ${totalRevenue.toFixed(2)}`;
      document.getElementById('report-total-incidents').textContent = incidentsData.length;
      document.getElementById('report-total-deliveries').textContent = deliveriesData.length;
    }

    // Task status update
    window.updateTaskStatus = async (taskId,newStatus)=>{
      try{ await updateDoc(doc(db,`artifacts/${appId}/public/data/work_orders`,taskId),{ status:newStatus, completedAt:serverTimestamp() }); showModal('Success!','Task status updated.'); }
      catch(err){ console.error(err); showModal('Error','Failed to update task.'); }
    };

    // Staff forms
    const invForm=document.getElementById('inventory-form');
    invForm.onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const data={ coopId:document.getElementById('coop-id').value, itemType:itemType.value, itemName:itemName.value, quantity:parseInt(quantity.value,10), deliveryNotes:deliveryNotes.value, timestamp:serverTimestamp(), userId:auth.currentUser.uid };
      try{ await addDoc(collection(db,`artifacts/${appId}/users/${auth.currentUser.uid}/inventory`), data); showModal('Success!','Inventory logged.'); invForm.reset(); }
      catch(err){ console.error(err); showModal('Error','Failed to log inventory.'); }
    };

    const salesForm=document.getElementById('sales-form');
    salesForm.onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const data={ saleItem:saleItem.value, saleQuantity:parseInt(saleQuantity.value,10), salePrice:parseFloat(salePrice.value), saleNotes:saleNotes.value, timestamp:serverTimestamp(), userId:auth.currentUser.uid };
      try{ await addDoc(collection(db,`artifacts/${appId}/users/${auth.currentUser.uid}/sales`), data); showModal('Success!','Sales logged.'); salesForm.reset(); }
      catch(err){ console.error(err); showModal('Error','Failed to log sales.'); }
    };

    const incForm=document.getElementById('incidents-form');
    incForm.onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const file=document.getElementById('incidentPhoto').files[0]; let photoUrl=null;
      try{ if(file){ const r=sref(storage,`incidents/${Date.now()}_${file.name}`); await uploadBytes(r,file); photoUrl=await getDownloadURL(r); }
        const data={ incidentType:incidentType.value, incidentTitle:incidentTitle.value, incidentNotes:incidentNotes.value, photoUrl, status:'Pending', timestamp:serverTimestamp(), userId:auth.currentUser.uid };
        await addDoc(collection(db,`artifacts/${appId}/users/${auth.currentUser.uid}/incidents`), data);
        showModal('Success!','Incident reported.'); incForm.reset();
      }catch(err){ console.error(err); showModal('Error','Failed to report incident.'); }
    };

    // Public marketplace
    const orderFormContainer=document.getElementById('order-form-container');
    document.getElementById('buy-birds').onclick=()=>{ document.getElementById('product').value='Birds'; orderFormContainer.classList.remove('hidden'); orderFormContainer.scrollIntoView({behavior:'smooth'}); };
    document.getElementById('buy-eggs').onclick=()=>{ document.getElementById('product').value='Eggs'; orderFormContainer.classList.remove('hidden'); orderFormContainer.scrollIntoView({behavior:'smooth'}); };
    document.getElementById('order-form').onsubmit = async (e)=>{
      e.preventDefault();
      const orderData={ customerName:customerName.value, customerEmail:customerEmail.value, product:product.value, quantity:parseInt(quantity.value,10), paymentMethod:paymentMethod.value, status:'Pending', deliveryHistory:[{ status:'Order Submitted', timestamp:serverTimestamp() }], timestamp:serverTimestamp() };
      try{ const ref = await addDoc(collection(db,`artifacts/${appId}/public/data/orders`), orderData); showModal('Order Submitted!',`Your Order ID is: <strong class='text-teal-600'>${ref.id}</strong>.`); e.target.reset(); orderFormContainer.classList.add('hidden'); }
      catch(err){ console.error(err); showModal('Order Failed','Please try again.'); }
    };

    document.getElementById('track-order-button').onclick = async ()=>{
      const orderId=document.getElementById('order-id-input').value.trim(); if(!orderId){ showModal('Input Required','Please enter your Order ID.'); return; }
      document.getElementById('tracking-result').classList.add('hidden'); document.getElementById('tracking-error').classList.add('hidden');
      try{ const snap=await getDoc(doc(db,`artifacts/${appId}/public/data/orders`,orderId));
        if(snap.exists()){
          const d=snap.data();
          result_order_id.textContent=orderId; result_product.textContent=d.product; result_quantity.textContent=d.quantity; result_payment_method.textContent=d.paymentMethod;
          const statusSpan=document.getElementById('result-status'); statusSpan.textContent=d.status; statusSpan.classList.remove('text-blue-500','text-green-500','text-orange-500');
          if(['Pending','Processing'].includes(d.status)) statusSpan.classList.add('text-orange-500'); else if(d.status==='Out for Delivery') statusSpan.classList.add('text-blue-500'); else if(d.status==='Delivered') statusSpan.classList.add('text-green-500');
          const ul=document.getElementById('result-delivery-history'); ul.innerHTML='';
          (d.deliveryHistory||[]).forEach(step=>{ const li=document.createElement('li'); const jsDate = step.timestamp?.toDate? step.timestamp.toDate(): (step.timestamp instanceof Date? step.timestamp:null); li.textContent = jsDate? `${jsDate.toLocaleString()}: ${step.status}` : step.status; ul.appendChild(li); });
          document.getElementById('tracking-result').classList.remove('hidden');
        } else document.getElementById('tracking-error').classList.remove('hidden');
      }catch(err){ console.error(err); showModal('Error','Error while tracking order.'); }
    };

    // Traceability
    document.getElementById('batch-generator-form').onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const data={ coopId:coopId.value, birdCount:birdCount.value, feedType:feedType.value, batchNotes:batchNotes.value, timestamp:serverTimestamp(), userId:auth.currentUser.uid };
      const hashString = `${data.coopId}-${data.birdCount}-${data.feedType}-${Date.now()}-${Math.random()}`;
      const buffer = new TextEncoder().encode(hashString);
      let digestHex = 'simulated_hash_'+Math.random().toString(36).slice(2);
      if(crypto.subtle){ const digest=await crypto.subtle.digest('SHA-256', buffer); digestHex=Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
      data.blockchainHash = digestHex;
      try{ const ref=await addDoc(collection(db,`artifacts/${appId}/public/data/batches`), data); generated_batch_id.textContent=ref.id; document.getElementById('generated-qr-code').classList.remove('hidden'); showModal('Batch Generated!',`Batch ID: <strong class='text-teal-600'>${ref.id}</strong>`); e.target.reset(); }
      catch(err){ console.error(err); showModal('Error','Failed to generate batch.'); }
    };
    document.getElementById('copy-qr-code').onclick=()=>{ const id=generated_batch_id.textContent; navigator.clipboard.writeText(id).then(()=>showModal('Copied!','Batch ID copied.')).catch(()=>showModal('Copy Error','Select and copy manually.')); };
    document.getElementById('validate-batch-button').onclick = async ()=>{
      const batchId=document.getElementById('batch-id-input').value.trim(); if(!batchId){ showModal('Input Required','Enter a Batch ID.'); return; }
      validation_result.classList.add('hidden'); validation_error.classList.add('hidden');
      try{ const snap=await getDoc(doc(db,`artifacts/${appId}/public/data/batches`,batchId));
        if(snap.exists()){
          const d=snap.data(); result_batch_id.textContent=batchId; result_coop_id.textContent=d.coopId; result_bird_count.textContent=d.birdCount; result_feed_type.textContent=d.feedType; result_blockchain_hash.textContent=d.blockchainHash; result_batch_notes.textContent=d.batchNotes||''; validation_result.classList.remove('hidden');
        } else validation_error.classList.remove('hidden');
      }catch(err){ console.error(err); showModal('Error','Validation failed.'); }
    };

    // Warehouse
    document.getElementById('warehouse-delivery-form').onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const data={ itemName:warehouse_item_name.value, itemType:warehouse_item_type.value, quantity:parseInt(warehouse_quantity.value,10), supplier:warehouse_supplier.value, timestamp:serverTimestamp(), adminId:auth.currentUser.uid };
      try{
        await addDoc(collection(db,`artifacts/${appId}/public/data/warehouse_deliveries`), data);
        const stockRef = doc(db,`artifacts/${appId}/public/data/warehouse_stock`, data.itemName);
        const stockSnap = await getDoc(stockRef);
        if(stockSnap.exists()) await updateDoc(stockRef,{ quantity: (Number(stockSnap.data().quantity)||0)+data.quantity, timestamp:serverTimestamp()});
        else await setDoc(stockRef,{ itemName:data.itemName, itemType:data.itemType, quantity:data.quantity, timestamp:serverTimestamp()});
        showModal('Success!','Delivery logged & stock updated.'); e.target.reset();
      }catch(err){ console.error(err); showModal('Error','Failed to log delivery.'); }
    };
    document.getElementById('dispatch-form').onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const itemId=dispatch_item_name.value; const qty=parseInt(dispatch_quantity.value,10); const staffUid=dispatch_staff_uid.value.trim();
      if(!itemId||!qty||!staffUid){ showModal('Input Required','Fill all dispatch fields.'); return; }
      try{
        const stockRef=doc(db,`artifacts/${appId}/public/data/warehouse_stock`, itemId); const stockSnap=await getDoc(stockRef);
        if(!stockSnap.exists() || (Number(stockSnap.data().quantity)||0) < qty){ showModal('Dispatch Failed','Not enough stock.'); return; }
        await updateDoc(stockRef,{ quantity: (Number(stockSnap.data().quantity)||0)-qty, timestamp:serverTimestamp()});
        await addDoc(collection(db,`artifacts/${appId}/public/data/dispatches`),{ itemName:stockSnap.data().itemName, quantity:qty, staffUid, timestamp:serverTimestamp(), adminId:auth.currentUser.uid });
        await addDoc(collection(db,`artifacts/${appId}/users/${staffUid}/inventory`),{ itemName:stockSnap.data().itemName, itemType:stockSnap.data().itemType, quantity:qty, coopId:'Dispatch from Warehouse', deliveryNotes:`Dispatched by admin ${auth.currentUser.uid}`, timestamp:serverTimestamp() });
        showModal('Dispatch Successful!`, `${qty} units dispatched.`);
        e.target.reset();
      }catch(err){ console.error(err); showModal('Error','Failed to dispatch item.'); }
    };

    // Reports
    document.getElementById('download-pdf-report').onclick = ()=>{
      const docx=new jsPDF(); docx.text('NSA Ecosystem Report',10,10); docx.setFontSize(12); docx.text(`Generated: ${new Date().toLocaleDateString()}`,10,20);
      const sTable=salesData.map(s=>[s.id,s.saleItem,s.saleQuantity,`GHS ${(Number(s.salePrice)||0).toFixed(2)}`, toLocalStringSafe(s.timestamp)]);
      autoTable(docx,{startY:30, head:[['ID','Item','Qty','Revenue','Date']], body:sTable});
      const y=docx.lastAutoTable.finalY+10; const iTable=incidentsData.map(i=>[i.id,i.incidentTitle||'',i.incidentType,i.status,toLocalStringSafe(i.timestamp)]);
      autoTable(docx,{startY:y, head:[['ID','Title','Type','Status','Date']], body:iTable});
      docx.save('NSA_Report.pdf'); showModal('Download Complete','PDF report downloaded.');
    };
    document.getElementById('download-excel-report').onclick=()=>{
      const rows=[["NSA Ecosystem Report"],[`Generated: ${new Date().toLocaleDateString()}`],[],["Sales Summary"],["ID","Item","Quantity","Revenue","Date"], ...salesData.map(s=>[s.id,s.saleItem,s.saleQuantity,Number(s.salePrice)||0,toLocalStringSafe(s.timestamp)]), [], ["Incident Summary"],["ID","Title","Type","Status","Date"], ...incidentsData.map(i=>[i.id,i.incidentTitle||'',i.incidentType,i.status,toLocalStringSafe(i.timestamp)])];
      const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Report'); XLSX.writeFile(wb,'NSA_Report.xlsx'); showModal('Download Complete','Excel report downloaded.');
    };

    // BLE simulate
    document.getElementById('simulate-ble-data').onclick=async()=>{
      const mock=[{id:'staff1',name:'Nana Yaw'},{id:'staff2',name:'Aisha'},{id:'staff3',name:'Kofi Mensah'}];
      const m=mock[Math.floor(Math.random()*mock.length)]; const lat=5.6148 + (Math.random()-0.5)*0.05; const lng=-0.1869 + (Math.random()-0.5)*0.05;
      try{ await addDoc(collection(db,`artifacts/${appId}/public/data/ble_logs`),{ deviceName:`${m.name}'s ID Card`, userId:m.id, latitude:lat, longitude:lng, timestamp:serverTimestamp()}); showModal('BLE Log Simulated',`New BLE log for ${m.name}.`);}catch(err){ console.error(err); showModal('Error','Failed to simulate BLE data.'); }
    };

    // Roles management (Callable Function)
    const setRoleFn = httpsCallable(functions, 'setUserRole');
    document.getElementById('set-role-form').onsubmit = async (e)=>{
      e.preventDefault(); if(!requireAuth()) return;
      const email=document.getElementById('role-email').value.trim(); const role=document.getElementById('role-value').value;
      try{ await setRoleFn({ email, role }); showModal('Role Updated',`Set <strong>${role}</strong> for <strong>${email}</strong>.`); e.target.reset(); }
      catch(err){ console.error(err); showModal('Error', 'Failed to set role. Ensure you are admin and Functions are deployed.'); }
    };

  </script>

  <!-- ================== Cloud Functions (reference) ==================
  // functions/package.json
  {
    "name": "nsa-functions",
    "engines": { "node": "20" },
    "dependencies": { "firebase-admin": "^12.0.0", "firebase-functions": "^5.0.0" }
  }

  // functions/index.js
  import * as functions from 'firebase-functions';
  import * as admin from 'firebase-admin';
  admin.initializeApp();
  const db = admin.firestore();

  export const setUserRole = functions.https.onCall( async (data, context) => {
    // Require caller to be admin
    if (!context.auth || context.auth.token.role !== 'admin') {
      throw new functions.https.HttpsError('permission-denied', 'Admins only');
    }
    const { email, role } = data;
    if (!email || !['admin','staff','customer'].includes(role)) {
      throw new functions.https.HttpsError('invalid-argument', 'Invalid email/role');
    }
    const user = await admin.auth().getUserByEmail(email);
    await admin.auth().setCustomUserClaims(user.uid, { role });
    await db.doc(`roles/${user.uid}`).set({ role, updatedAt: admin.firestore.FieldValue.serverTimestamp(), email }, { merge: true });
    await admin.auth().revokeRefreshTokens(user.uid); // force token refresh
    return { ok: true, uid: user.uid };
  });

  // Deploy:
  // firebase deploy --only functions:setUserRole

  // ================== Firestore Security Rules (reference) ==================
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn() { return request.auth != null; }
      function isAdmin() { return isSignedIn() && request.auth.token.role == 'admin'; }
      function isStaff() { return isSignedIn() && request.auth.token.role == 'staff'; }

      // Public readable datasets
      match /artifacts/{app}/public/data/{doc=**} {
        allow read: if true;
        allow write: if isAdmin();
      }

      // User private data
      match /artifacts/{app}/users/{uid}/{coll}/{doc} {
        allow read, write: if isSignedIn() && request.auth.uid == uid;
      }

      // Work orders: admins manage; staff can update own status only
      match /artifacts/{app}/public/data/work_orders/{taskId} {
        allow read: if isSignedIn();
        allow create, delete, update: if isAdmin();
        allow update: if isStaff() && request.resource.data.assignedTo == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status','completedAt']);
      }

      // Roles collection protected
      match /roles/{uid} {
        allow read: if isAdmin();
        allow write: if isAdmin();
      }
    }
  }

  // Deploy:
  // firebase deploy --only firestore:rules
  =================================================================== -->
</body>
</html>
